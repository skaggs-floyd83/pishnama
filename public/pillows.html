<!doctype html>
<!--
  Project: Pishnama â€” Pillows Fabric Tagging (Developer-Commented Copy)
  File: pillows_commented_dev.html
  Purpose:
    Two-stage flow to upload a sofa+pillows image, then tag pillow locations per fabric
    and generate previews using up to THREE fabrics. Pure HTML/CSS/vanilla JS. No network calls here.

  Key UX decisions (preserve behavior exactly):
    â€¢ Hamburger is icon-only (â˜°). Menu links to sofa & pillows pages.
    â€¢ File selection buttons are icon-only (ğŸ“ for choose file, ğŸ“· for camera).
    â€¢ Stages:
        1) Upload: user selects base photo; Continue enabled after image loads.
        2) Fabrics: fabric-specific tagging â€” each fabric has its own set of tag points.
    â€¢ Overlay tags are fabric swatch squares (NO numbers/circles), positioned absolutely with normalized coords.
    â€¢ Selection frame:
        â€“ Title â€œØ§Ù†ØªØ®Ø§Ø¨ Ù¾Ø§Ø±Ú†Ù‡ {Ø§ÙˆÙ„|Ø¯ÙˆÙ…|Ø³ÙˆÙ…}â€ gets its own line (top-right).
        â€“ Buttons (file/camera) are on the next line, right-aligned; thumbnail sits at the left.
    â€¢ Add Fabric button:
        â€“ Label updates to next ordinal (Ø¯ÙˆÙ… / Ø³ÙˆÙ…).
        â€“ Completely HIDDEN when three fabrics already exist (not disabled).
        â€“ Enabled only when current fabric has an image AND at least one tag point.
    â€¢ Undo (â†©) removes the last tag of the CURRENT fabric only; Clear (ğŸ—‘ï¸) removes all tags of current fabric.
    â€¢ Mobile persistence: base image Blob URL is carried from stage 1 to stage 2 to ensure visibility after step change.
-->
<html lang="fa" dir="rtl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>Ù¾ÛŒØ´Ù†Ù…Ø§ â€” Ú©ÙˆØ³Ù†â€ŒÙ‡Ø§ (v3, commented)</title>
<style>
  :root{--bg:#0b1020;--card:#0f162b;--muted:#94a3b8;--text:#e5e7eb;--border:#243045;--accent:#22c55e;--blue:#1f3a8a}
  html,body{margin:0;background:var(--bg);color:var(--text);font-family:Vazirmatn,IRANSans,Segoe UI,Roboto,Arial}
  .wrap{max-width:480px;margin:0 auto;height:100svh;display:flex;flex-direction:column}
  .bar{position:relative;padding:10px 14px;display:flex;justify-content:flex-start;align-items:center}
  /* Icon-only hamburger */
  .hamburger{border:1px solid var(--border);background:#0f1a33;color:#e2e8f0;border-radius:10px;padding:8px 12px;cursor:pointer}
  .menu{position:absolute;top:48px;right:14px;background:#0f162b;border:1px solid var(--border);border-radius:12px;min-width:180px;display:none;flex-direction:column;overflow:hidden;z-index:10}
  .menu a{padding:10px 12px;color:#e5e7eb;text-decoration:none;border-bottom:1px solid var(--border);display:block}
  .menu a:last-child{border-bottom:0}
  .menu.show{display:flex}

  .card{background:var(--card);border:1px solid var(--border);border-radius:14px;padding:12px;margin:10px}
  .row{display:flex;align-items:center;gap:8px}
  .btn{border:1px solid var(--border);background:#0f1a33;color:#e2e8f0;border-radius:12px;padding:10px 14px;cursor:pointer}
  .btn.primary{background:var(--blue);border-color:var(--blue)}
  .btn:disabled{opacity:.5;cursor:not-allowed}

  .thumb{position:relative;display:flex;align-items:center;justify-content:center;border:1px dashed var(--border);border-radius:12px;min-height:120px;background:#0f172a;overflow:hidden}
  .thumb img{max-width:100%;max-height:100%;width:auto;height:auto;display:block}

  .toggle{display:inline-flex;border:1px solid var(--border);border-radius:999px;overflow:hidden}
  .toggle button{border:0;background:transparent;color:#cbd5e1;padding:8px 12px}
  .toggle .active{background:#0f1a33;color:#fff}

  .viewport{flex:1;display:flex;flex-direction:column;gap:10px;overflow:hidden}
  .section{display:none;flex:1;overflow:hidden}
  .section.active{display:flex;flex-direction:column}

  #baseFrame, #tagFrame { height: 220px !important; width: 100%; }
  #navRow{margin:0 10px;display:flex;justify-content:space-between;align-items:center}
  .controls{margin:0 10px;display:flex;flex-direction:column;gap:10px}
  .rightline{display:flex;justify-content:flex-start;align-items:center;gap:8px}
  .between{display:flex;justify-content:space-between;align-items:center}

  /* Selection frame with two rows: (1) title line, (2) buttons+thumb line */
  .selectFrame{border:1px dashed var(--border);border-radius:12px;padding:10px;background:#0f172a;display:flex;flex-direction:column;gap:10px;position:relative}

  /* Fabric-tag overlays: 16Ã—16 swatches; background image = fabric */
  .overlay{position:absolute;transform:translate(-50%,-50%);width:16px;height:16px;border-radius:4px;border:1px solid var(--accent);background-size:cover;background-position:center}

  /* Tiny remove icon inside fabric selection frame */
  .tinyX{position:absolute;left:8px;top:8px;background:#0f1a33;border:1px solid var(--border);border-radius:8px;padding:4px 6px;cursor:pointer;font-size:14px;line-height:1}
  .tinyX:hover{background:#17213d}
  /* Toast */
  #toast{position:fixed;left:50%;transform:translateX(-50%);bottom:20px;background:#0f1a33;border:1px solid var(--border);color:#e5e7eb;padding:8px 12px;border-radius:10px;opacity:0;transition:opacity .25s;pointer-events:none;z-index:9999}
  #toast.show{opacity:1}

</style>
</head>
<body>
<div class="wrap">
  <!-- Header: hamburger only -->
  <div class="bar">
    <button class="hamburger" id="hambtn">â˜°</button>
    <div class="menu" id="menu">
      <a href="sofa.html">ğŸ›‹ï¸ Ø·Ø±Ø§Ø­ÛŒ Ù…Ø¨Ù„</a>
      <a href="pillows.html">ğŸ›‹ï¸ Ø·Ø±Ø§Ø­ÛŒ Ú©ÙˆØ³Ù†â€ŒÙ‡Ø§</a>
    </div>
  </div>

  <div class="viewport">
    <!-- ===== Stage 1: Upload sofa + pillows image ===== -->
    <section id="step-upload" class="section active">
      <div class="card">
        <h3 style="margin:0 0 8px">ğŸ“· Ø¢Ù¾Ù„ÙˆØ¯ ØªØµÙˆÛŒØ± Ù…Ø¨Ù„ + Ú©ÙˆØ³Ù†â€ŒÙ‡Ø§</h3>
        <div class="thumb" id="baseFrame"><!-- Keep base image visible after Next (mobile) --><img id="baseImg" alt=""></div>
        <div class="row between" style="margin-top:8px">
          <!-- Match sofa page layout: file+camera (right), Continue (left) -->
          <div class="row">
            <label class="btn" title="Ø§Ù†ØªØ®Ø§Ø¨ ÙØ§ÛŒÙ„">ğŸ“<input id="photoFile" type="file" accept="image/*" hidden></label>
            <label class="btn" title="Ø¯ÙˆØ±Ø¨ÛŒÙ†">ğŸ“·<input id="photoCam" type="file" accept="image/*" capture="environment" hidden></label>
          </div>
          <button class="btn primary" id="goNext" disabled>Ø§Ø¯Ø§Ù…Ù‡ â—€</button>
        </div>
      </div>
    </section>

    <!-- ===== Stage 2: Tag pillows + choose fabrics ===== -->
    <section id="step-fabrics" class="section">
      <div class="row" id="navRow">
        <button class="btn" id="prevBtn">Ù‚Ø¨Ù„ÛŒ â–¶</button>
        <button class="btn" id="nextBtn">â—€ Ø¨Ø¹Ø¯ÛŒ</button>
      </div>

      <div class="card">
        <!-- Icon-only controls centered above the image -->
        <div class="row" style="justify-content:center;gap:8px;margin-bottom:8px">
          <button class="btn" id="undoBtn" title="ÙˆØ§Ú¯Ø±Ø¯">â†©</button>
          <button class="btn" id="clearBtn" title="Ø­Ø°Ù Ù‡Ù…Ù‡">ğŸ—‘ï¸</button>
        </div>
        <!-- Tagging frame: overlays are small fabric swatches -->
        <div class="thumb" id="tagFrame" style="position:relative"><img id="baseImg2" alt=""></div>
      </div>

      <!-- Fabric selection frame: title line + buttons/thumbnail line -->
      <div class="controls">
        <div class="selectFrame">
          <button class="tinyX" id="removeFabBtn" title="Ø­Ø°Ù Ù¾Ø§Ø±Ú†Ù‡">ğŸ—‘ï¸</button>
          <div class="row" style="justify-content:flex-start;width:100%">
            <strong id="selTitle" style="color:var(--muted);font-size:.95rem">Ø§Ù†ØªØ®Ø§Ø¨ Ù¾Ø§Ø±Ú†Ù‡ Ø§ÙˆÙ„</strong>
          </div>
          <div class="row" style="justify-content:space-between;width:100%">
            <div class="rightline">
              <label class="btn" title="Ø¢Ù¾Ù„ÙˆØ¯ Ù¾Ø§Ø±Ú†Ù‡">ğŸ“<input id="fabFile" type="file" accept="image/*" hidden></label>
              <label class="btn" title="Ø¯ÙˆØ±Ø¨ÛŒÙ†">ğŸ“·<input id="fabCam" type="file" accept="image/*" capture="environment" hidden></label>
            </div>
            <img id="fabMini" alt="" style="width:36px;height:36px;border-radius:8px;border:1px solid var(--border);object-fit:cover;background:#0f172a;visibility:hidden">
          </div>
        </div>

        <!-- Add Fabric: HIDDEN at 3 fabrics. Enabled only when current fabric has image + â‰¥1 tag -->
        <div class="rightline">
          <button class="btn" id="addBtn" disabled>â• Ø§ÙØ²ÙˆØ¯Ù† Ù¾Ø§Ø±Ú†Ù‡ Ø¯ÙˆÙ…</button>
        </div>

        <!-- Quality & Preview (integration point) -->
        <div class="rightline">
          <div class="toggle" id="qToggle">
            <button class="active" data-q="standard">Ú©ÛŒÙÛŒØª Ù…Ø¹Ù…ÙˆÙ„ÛŒ</button>
            <button data-q="high">Ú©ÛŒÙÛŒØª Ø¨Ø§Ù„Ø§</button>
          </div>
          <button class="btn primary" id="previewBtn">âœ¨ Ù¾ÛŒØ´â€ŒÙ†Ù…Ø§ÛŒØ´</button>
        </div>
      </div>
    </section>
  </div>
</div>

<script>
  /* ---------- Utilities & State ---------- */

  // Persian ordinals for labels
  function faOrdinal(n){ return n===1?'Ø§ÙˆÙ„':(n===2?'Ø¯ÙˆÙ…':'Ø³ÙˆÙ…'); }

  // Hamburger toggle with outside-click close
  const hambtn=document.getElementById('hambtn');
  const menu=document.getElementById('menu');
  hambtn.addEventListener('click', ()=> menu.classList.toggle('show'));
  document.addEventListener('click', (e)=>{ if(!menu.contains(e.target) && e.target!==hambtn) menu.classList.remove('show'); });

  // Stage 1 elements
  const stepUpload=document.getElementById('step-upload');
  const stepFabs=document.getElementById('step-fabrics');
  const photoFile=document.getElementById('photoFile');
  const photoCam=document.getElementById('photoCam');
  const baseImg=document.getElementById('baseImg');
  const baseImg2=document.getElementById('baseImg2');
  const goNext=document.getElementById('goNext');

  // Stage 2 elements
  const tagFrame=document.getElementById('tagFrame');
  const prevBtn=document.getElementById('prevBtn');
  const nextBtn=document.getElementById('nextBtn');
  const undoBtn=document.getElementById('undoBtn');
  const clearBtn=document.getElementById('clearBtn');
  const fabFile=document.getElementById('fabFile');
  const fabCam=document.getElementById('fabCam');
  const addBtn=document.getElementById('addBtn');
  const qToggle=document.getElementById('qToggle');
  const previewBtn=document.getElementById('previewBtn');
  const fabMini=document.getElementById('fabMini');

  // Per-fabric state model:
  //   fabrics[i] owns: url (image), quality flag, and its own list of tag points [{x,y}] in normalized coords (0..1)
  let fabrics=[]; // each item: { id:number, url:string, quality:'standard'|'high', tags:Array<{x:number,y:number}> }
  let i=0;        // current fabric index being edited
  let photoOk=false;
  let baseObjectURL=null; // persisted blob URL across steps (fixes mobile issue where image would disappear)

  /* ---------- Helpers ---------- */

  // Create & persist a blob URL for stage 1; do NOT revoke until replaced (we reuse it in stage 2)
  function loadBase(file){
    if(baseObjectURL){ URL.revokeObjectURL(baseObjectURL); baseObjectURL=null; }
    baseObjectURL = URL.createObjectURL(file);
    baseImg.src = baseObjectURL;
  }

  function setFabricFromFile(file){
    const url=URL.createObjectURL(file);
    fabrics[i].url=url;
    fabMini.src=url;
    fabMini.style.visibility='visible';
    redraw(); updateUI();
  }

  function toFabs(){
    stepUpload.classList.remove('active'); 
    stepFabs.classList.add('active'); 
    // keep same base image in stage 2
    baseImg2.src = baseObjectURL || baseImg.src;
    ensureFirstFabric(); 
    updateUI();
  }
  function toUpload(){ stepFabs.classList.remove('active'); stepUpload.classList.add('active'); }
  function ensureFirstFabric(){ if(fabrics.length===0){ fabrics.push({id:0,url:'',quality:'standard',tags:[]}); i=0; } }
  function selectionDone(cur){ return !!cur && !!cur.url && cur.tags.length>0; }

  /* ---------- Core UI sync ----------
     Responsibilities:
       1) Prev/Next enablement
       2) Add Fabric: show/hide + label + enablement rules
       3) Preview gating (needs â‰¥1 tag on current fabric)
       4) Title ordinal updates and thumbnail visibility
  ------------------------------------ */
  function updateUI(){
    const cur=fabrics[i];
    prevBtn.disabled=false;
    nextBtn.disabled=(i>=fabrics.length-1);

    // Add Fabric: hide at THREE fabrics; else show with next ordinal; enabled only when current selection is done
    if(fabrics.length>=3){
      addBtn.style.display='none';
    }else{
      addBtn.style.display='inline-block';
      addBtn.disabled = !selectionDone(cur);
      const nextOrdinal = faOrdinal(Math.min(fabrics.length+1,3));
      addBtn.textContent = `â• Ø§ÙØ²ÙˆØ¯Ù† Ù¾Ø§Ø±Ú†Ù‡ ${nextOrdinal}`;
    }

    // Generate is always enabled; validation happens on click now
    previewBtn.disabled = false;

    // Title reflects current fabricâ€™s ordinal
    const selTitle = document.getElementById('selTitle');
    if(selTitle) selTitle.textContent = `Ø§Ù†ØªØ®Ø§Ø¨ Ù¾Ø§Ø±Ú†Ù‡ ${faOrdinal(i+1)}`;

    // Thumbnail mirrors current fabric image
    if(cur && cur.url){ fabMini.src=cur.url; fabMini.style.visibility='visible'; }
    else { fabMini.style.visibility='hidden'; }
  }

  /* ---------- Overlay rendering ---------- */

  function addOverlay(x,y,url){
    // Visual tag = 16px square carrying the fabric texture
    const d=document.createElement('div');
    d.className='overlay';
    d.style.left=(x*100)+'%';
    d.style.top=(y*100)+'%';
    d.style.backgroundImage=`url(${url})`;
    tagFrame.appendChild(d);
  }

  function redraw(){
    tagFrame.querySelectorAll('.overlay').forEach(n=>n.remove());
    fabrics.forEach(f=> f.tags.forEach(t=> addOverlay(t.x,t.y,f.url)) );
  }

  /* ---------- Event wiring ---------- */

  // Stage 1 upload
  photoFile.addEventListener('change', e=>{
    const f=e.target.files?.[0]; if(!f) return;
    photoOk=true;
    loadBase(f);
    goNext.disabled=true;
    baseImg.onload = ()=>{ goNext.disabled=false; };
  });
  photoCam.addEventListener('change', ()=>photoFile.dispatchEvent(new Event('change')));
  goNext.addEventListener('click', ()=>{ if(photoOk) toFabs(); });

  // Prev/Next between fabrics; Prev from i==0 returns to stage 1
  prevBtn.addEventListener('click', ()=>{ if(i>0){ i--; updateUI(); } else { toUpload(); } });
  nextBtn.addEventListener('click', ()=>{ if(i<fabrics.length-1){ i++; updateUI(); } });

  // Fabric asset selection for current fabric
  fabFile.addEventListener('change', e=>{ const f=e.target.files?.[0]; if(!f) return; setFabricFromFile(f); });
  fabCam .addEventListener('change', e=>{ const f=e.target.files?.[0]; if(!f) return; setFabricFromFile(f); });

  // Add new fabric slot (up to 3)
  addBtn.addEventListener('click', ()=>{
    if(addBtn.disabled) return;
    fabrics.push({id:fabrics.length,url:'',quality:'standard',tags:[]});
    i=fabrics.length-1; updateUI();
  });

  // Quality toggle (per-fabric) â€” UI only
  qToggle.addEventListener('click', e=>{
    const b=e.target.closest('button'); if(!b||!fabrics[i]) return;
    [...qToggle.children].forEach(x=>x.classList.toggle('active',x===b));
    fabrics[i].quality=b.dataset.q;
  });

  // Tagging: store NORMALIZED coords (0..1); overlays re-render from state
  const tagFrameEl=document.getElementById('tagFrame');
  tagFrameEl.addEventListener('click', e=>{
    if(!fabrics[i] || !fabrics[i].url) return; // must have a fabric image to tag pillows for that fabric
    const r=tagFrameEl.getBoundingClientRect();
    const x=(e.clientX-r.left)/r.width, y=(e.clientY-r.top)/r.height;
    fabrics[i].tags.push({x,y});
    addOverlay(x,y,fabrics[i].url);
    updateUI();
  });

  // Undo last tag and clear all tags for current fabric
  undoBtn.addEventListener('click', ()=>{
    if(!fabrics[i] || fabrics[i].tags.length===0) return;
    fabrics[i].tags.pop(); redraw(); updateUI();
  });
  clearBtn.addEventListener('click', ()=>{
    if(!fabrics[i]) return;
    fabrics[i].tags=[]; redraw(); updateUI();
  });


  // ---------- Validation before generation (pillows) ----------
  function validateBeforeGeneratePillows(){
    const errors = [];
    const warnings = [];

    // --- Mandatory checks ---
    if(!photoOk || !(baseImg2.src || baseImg.src)){
      errors.push("ØªØµÙˆÛŒØ± Ù¾Ø§ÛŒÙ‡Ù” Ù…Ø¨Ù„ + Ú©ÙˆØ³Ù†â€ŒÙ‡Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ù†Ø´Ø¯Ù‡ Ø§Ø³Øª.");
    }
    const fabricsWithImg = fabrics.filter(f=>!!f.url);
    if(fabricsWithImg.length===0){
      errors.push("Ø­Ø¯Ø§Ù‚Ù„ ÛŒÚ© ØªØµÙˆÛŒØ± Ù¾Ø§Ø±Ú†Ù‡ Ø¨Ø§ÛŒØ¯ Ø¢Ù¾Ù„ÙˆØ¯ Ø´ÙˆØ¯.");
    }
    const anyHasTag = fabrics.some(f=> !!f.url && f.tags && f.tags.length>0);
    if(!anyHasTag){
      errors.push("Ø­Ø¯Ø§Ù‚Ù„ ÛŒÚ© Ø¨Ø±Ú†Ø³Ø¨ Ú©ÙˆØ³Ù† Ø¨Ø§ÛŒØ¯ Ø¨Ù‡ ÛŒÚ©ÛŒ Ø§Ø² Ù¾Ø§Ø±Ú†Ù‡â€ŒÙ‡Ø§ÛŒ Ø¢Ù¾Ù„ÙˆØ¯ Ø´Ø¯Ù‡ Ø§Ø®ØªØµØ§Øµ Ø¯Ø§Ø¯Ù‡ Ø´ÙˆØ¯.");
    }

    // --- Optional checks ---
    // A) Fabric images without any tags
    const imgNoTags = fabrics
      .map((f,idx)=>({f,idx}))
      .filter(({f})=> !!f.url && (!f.tags || f.tags.length===0))
      .map(({idx})=> `Ù¾Ø§Ø±Ú†Ù‡ ${faOrdinal(idx+1)}`);
    if(imgNoTags.length>0){
      warnings.push("Ù¾Ø§Ø±Ú†Ù‡â€ŒÙ‡Ø§ÛŒ Ø¨Ø¯ÙˆÙ† Ø¨Ø±Ú†Ø³Ø¨ Ú©ÙˆØ³Ù†: " + imgNoTags.join("ØŒ "));
    }

    return {errors, warnings};
  }

  // Replace previous click with validation flow
  previewBtn.addEventListener('click', ()=>{
    const {errors, warnings} = validateBeforeGeneratePillows();

    if(errors.length>0){
      alert("Ø®Ø·Ø§Ù‡Ø§ÛŒ Ø¶Ø±ÙˆØ±ÛŒ:\n- " + errors.join("\n- "));
      return;
    }
    if(warnings.length>0){
      const proceed = confirm("Ù…ÙˆØ§Ø±Ø¯ Ø§Ø®ØªÛŒØ§Ø±ÛŒ (Ù…ÛŒâ€ŒØªÙˆØ§Ù†ÛŒØ¯ Ø§ØµÙ„Ø§Ø­ Ú©Ù†ÛŒØ¯ ÛŒØ§ Ø§Ø¯Ø§Ù…Ù‡ Ø¯Ù‡ÛŒØ¯):\n- " + warnings.join("\n- ") + "\n\nØ§Ø¯Ø§Ù…Ù‡Ù” ØªÙˆÙ„ÛŒØ¯ØŸ");
      if(!proceed) return;
    }
    alert(`(Ø¯Ù…Ùˆ) Ù¾ÛŒØ´â€ŒÙ†Ù…Ø§ÛŒØ´ Ú©ÙˆØ³Ù† â€” Ù¾Ø§Ø±Ú†Ù‡ ${i+1} â€” Ú©ÛŒÙÛŒØª: ${fabrics[i].quality||'standard'}`);
  });

  // --- Toast helper (pillows) ---
  function showToast(msg){
    const t=document.getElementById('toast'); if(!t) return;
    t.textContent=msg; t.classList.add('show');
    setTimeout(()=>t.classList.remove('show'), 1600);
  }

  // --- Remove current fabric (pillows): clears image + tags, reorders, selects next ---
  ;(function(){
    const btn=document.getElementById('removeFabBtn');
    if(!btn) return;
    btn.addEventListener('click', ()=>{
      if(!fabrics[i]) return;
      const removedIndex = i;

      // Remove fabric; its tags live on the object so removal clears them
      fabrics.splice(i,1);

      if(fabrics.length===0){
        fabrics.push({id:0,url:'',quality:'standard',tags:[]});
        i=0;
      }else{
        // Reindex ids
        fabrics.forEach((f,ii)=>{ f.id=ii; });
        // Select the next fabric that was after the removed one (if any)
        i = Math.min(removedIndex, fabrics.length-1);
      }

      // Refresh UI (thumbnail + overlay)
      fabMini.style.visibility = fabrics[i].url ? 'visible' : 'hidden';
      if(fabrics[i].url) fabMini.src = fabrics[i].url;
      redraw();
      updateUI();
      showToast("Ù¾Ø§Ø±Ú†Ù‡ Ø­Ø°Ù Ø´Ø¯ â€” Ø¨Ø±Ú†Ø³Ø¨â€ŒÙ‡Ø§ÛŒ Ù…Ø±ØªØ¨Ø· Ù¾Ø§Ú© Ø´Ø¯Ù†Ø¯.");
    });
  })();

</script>
<div id="toast" role="status" aria-live="polite"></div>
</body>
</html>
