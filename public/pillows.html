<!doctype html>
<html lang="fa" dir="rtl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>Ù¾ÛŒØ´Ù†Ù…Ø§ â€” Ú©ÙˆØ³Ù†â€ŒÙ‡Ø§ (v3)</title>
<style>
  :root{--bg:#0b1020;--card:#0f162b;--muted:#94a3b8;--text:#e5e7eb;--border:#243045;--accent:#22c55e;--blue:#1f3a8a}
  html,body{margin:0;background:var(--bg);color:var(--text);font-family:Vazirmatn,IRANSans,Segoe UI,Roboto,Arial}
  .wrap{max-width:480px;margin:0 auto;height:100svh;display:flex;flex-direction:column}
  .bar{position:relative;padding:10px 14px;display:flex;justify-content:flex-start;align-items:center}
  .hamburger{border:1px solid var(--border);background:#0f1a33;color:#e2e8f0;border-radius:10px;padding:8px 12px;cursor:pointer}
  .menu{position:absolute;top:48px;right:14px;background:var(--card);border:1px solid var(--border);border-radius:12px;min-width:180px;display:none;flex-direction:column;overflow:hidden;z-index:10}
  .menu a{padding:10px 12px;color:#e5e7eb;text-decoration:none;border-bottom:1px solid var(--border);display:block}
  .menu a:last-child{border-bottom:0}
  .menu.show{display:flex}
  .card{background:var(--card);border:1px solid var(--border);border-radius:14px;padding:12px;margin:10px}
  .row{display:flex;align-items:center;gap:8px}
  .btn{border:1px solid var(--border);background:#0f1a33;color:#e2e8f0;border-radius:12px;padding:10px 14px;cursor:pointer}
  .btn.primary{background:var(--blue);border-color:var(--blue)}
  .btn:disabled{opacity:.5;cursor:not-allowed}
  .thumb{position:relative;display:flex;align-items:center;justify-content:center;border:1px dashed var(--border);border-radius:12px;min-height:120px;background:#0f172a;overflow:hidden}
  .thumb img{max-width:100%;max-height:100%;width:auto;height:auto;display:block}
  .toggle{display:inline-flex;border:1px solid var(--border);border-radius:999px;overflow:hidden}
  .toggle button{border:0;background:transparent;color:#cbd5e1;padding:8px 12px}
  .toggle .active{background:#0f1a33;color:#fff}
  .viewport{flex:1;display:flex;flex-direction:column;gap:10px;overflow:hidden}
  .section{display:none;flex:1;overflow:hidden}
  .section.active{display:flex;flex-direction:column}
  #baseFrame, #tagFrame { height: 220px !important; width: 100%; }
  #navRow{margin:0 10px;display:flex;justify-content:space-between;align-items:center}
  .controls{margin:0 10px;display:flex;flex-direction:column;gap:10px}
  .rightline{display:flex;justify-content:flex-start;align-items:center;gap:8px}
  .between{display:flex;justify-content:space-between;align-items:center}
  .selectFrame{border:1px dashed var(--border);border-radius:12px;padding:10px;background:#0f172a;display:flex;flex-direction:column;gap:10px;position:relative}
  .overlay{position:absolute;transform:translate(-50%,-50%);width:16px;height:16px;border-radius:4px;border:1px solid var(--accent);background-size:cover;background-position:center}
</style>
</head>
<body>
<div class="wrap">
  <div class="bar">
    <button class="hamburger" id="hambtn">â˜°</button>
    <div class="menu" id="menu">
      <a href="sofa.html">ğŸ›‹ï¸ Ø·Ø±Ø§Ø­ÛŒ Ù…Ø¨Ù„</a>
      <a href="pillows.html">ğŸ›‹ï¸ Ø·Ø±Ø§Ø­ÛŒ Ú©ÙˆØ³Ù†â€ŒÙ‡Ø§</a>
    </div>
  </div>

  <div class="viewport">
    <!-- STEP 1 -->
    <section id="step-upload" class="section active">
      <div class="card">
        <h3 style="margin:0 0 8px">ğŸ“· Ø¢Ù¾Ù„ÙˆØ¯ ØªØµÙˆÛŒØ± Ù…Ø¨Ù„ + Ú©ÙˆØ³Ù†â€ŒÙ‡Ø§</h3>
        <div class="thumb" id="baseFrame"><img id="baseImg" alt=""></div>
        <div class="row between" style="margin-top:8px">
          <div class="row">
            <label class="btn">ğŸ“<input id="photoFile" type="file" accept="image/*" hidden></label>
            <label class="btn">ğŸ“·<input id="photoCam" type="file" accept="image/*" capture="environment" hidden></label>
          </div>
          <button class="btn primary" id="goNext" disabled>Ø§Ø¯Ø§Ù…Ù‡ â—€</button>
        </div>
      </div>
    </section>

    <!-- STEP 2 -->
    <section id="step-fabrics" class="section">
      <div class="row" id="navRow">
        <button class="btn" id="prevBtn">Ù‚Ø¨Ù„ÛŒ â–¶</button>
        <button class="btn" id="nextBtn">â—€ Ø¨Ø¹Ø¯ÛŒ</button>
      </div>

      <div class="card">
        <div class="row" style="justify-content:center;gap:8px;margin-bottom:8px">
          <button class="btn" id="undoBtn" title="ÙˆØ§Ú¯Ø±Ø¯">â†©</button>
          <button class="btn" id="clearBtn" title="Ø­Ø°Ù Ù‡Ù…Ù‡">ğŸ—‘ï¸</button>
        </div>
        <div class="thumb" id="tagFrame" style="position:relative"><img id="baseImg2" alt=""></div>
      </div>

      <div class="controls">
        <div class="selectFrame">
          <div class="row" style="justify-content:flex-start;width:100%">
            <strong id="selTitle" style="color:var(--muted);font-size:.95rem">Ø§Ù†ØªØ®Ø§Ø¨ Ù¾Ø§Ø±Ú†Ù‡ Ø§ÙˆÙ„</strong>
          </div>
          <div class="row" style="justify-content:space-between;width:100%">
            <div class="rightline">
              <label class="btn">ğŸ“<input id="fabFile" type="file" accept="image/*" hidden></label>
              <label class="btn">ğŸ“·<input id="fabCam" type="file" accept="image/*" capture="environment" hidden></label>
            </div>
            <img id="fabMini" alt="" style="width:36px;height:36px;border-radius:8px;border:1px solid var(--border);object-fit:cover;background:#0f172a;visibility:hidden">
          </div>
        </div>

        <div class="rightline">
          <button class="btn" id="addBtn" disabled>â• Ø§ÙØ²ÙˆØ¯Ù† Ù¾Ø§Ø±Ú†Ù‡ Ø¯ÙˆÙ…</button>
        </div>

        <div class="rightline">
          <div class="toggle" id="qToggle">
            <button class="active" data-q="standard">Ú©ÛŒÙÛŒØª Ù…Ø¹Ù…ÙˆÙ„ÛŒ</button>
            <button data-q="high">Ú©ÛŒÙÛŒØª Ø¨Ø§Ù„Ø§</button>
          </div>
          <button class="btn primary" id="previewBtn" disabled>âœ¨ Ù¾ÛŒØ´â€ŒÙ†Ù…Ø§ÛŒØ´</button>
        </div>
      </div>
    </section>
  </div>
</div>

<script>
  function faOrdinal(n){ return n===1?'Ø§ÙˆÙ„':(n===2?'Ø¯ÙˆÙ…':'Ø³ÙˆÙ…'); }

  const hambtn=document.getElementById('hambtn');
  const menu=document.getElementById('menu');
  hambtn.addEventListener('click', ()=> menu.classList.toggle('show'));
  document.addEventListener('click', (e)=>{ if(!menu.contains(e.target) && e.target!==hambtn) menu.classList.remove('show'); });

  const stepUpload=document.getElementById('step-upload');
  const stepFabs=document.getElementById('step-fabrics');
  const photoFile=document.getElementById('photoFile');
  const photoCam=document.getElementById('photoCam');
  const baseImg=document.getElementById('baseImg');
  const baseImg2=document.getElementById('baseImg2');
  const goNext=document.getElementById('goNext');

  const tagFrame=document.getElementById('tagFrame');
  const prevBtn=document.getElementById('prevBtn');
  const nextBtn=document.getElementById('nextBtn');
  const undoBtn=document.getElementById('undoBtn');
  const clearBtn=document.getElementById('clearBtn');

  const fabFile=document.getElementById('fabFile');
  const fabCam=document.getElementById('fabCam');
  const addBtn=document.getElementById('addBtn');
  const qToggle=document.getElementById('qToggle');
  const previewBtn=document.getElementById('previewBtn');
  const fabMini=document.getElementById('fabMini');

  let fabrics=[]; // {id,url,quality:'standard',tags:[{x,y}]}
  let i=0;
  let photoOk=false;
  let baseObjectURL=null;

  function loadBase(file){
    if(baseObjectURL){ URL.revokeObjectURL(baseObjectURL); baseObjectURL=null; }
    baseObjectURL = URL.createObjectURL(file);
    baseImg.src = baseObjectURL;
  }

  function setFabricFromFile(file){
    const url=URL.createObjectURL(file);
    fabrics[i].url=url;
    fabMini.src=url;
    fabMini.style.visibility='visible';
    redraw(); updateUI();
  }

  function toFabs(){
    stepUpload.classList.remove('active'); 
    stepFabs.classList.add('active'); 
    baseImg2.src = baseObjectURL || baseImg.src;
    ensureFirstFabric(); 
    updateUI();
  }
  function toUpload(){ stepFabs.classList.remove('active'); stepUpload.classList.add('active'); }
  function ensureFirstFabric(){ if(fabrics.length===0){ fabrics.push({id:0,url:'',quality:'standard',tags:[]}); i=0; } }
  function selectionDone(cur){ return !!cur && !!cur.url && cur.tags.length>0; }

  function updateUI(){
    const cur=fabrics[i];
    prevBtn.disabled=false;
    nextBtn.disabled=(i>=fabrics.length-1);

    // Add button: hide at >=3, otherwise show with proper text
    if(fabrics.length>=3){
      addBtn.style.display='none';
    }else{
      addBtn.style.display='inline-block';
      addBtn.disabled = !selectionDone(cur);
      const nextOrdinal = faOrdinal(Math.min(fabrics.length+1,3));
      addBtn.textContent = `â• Ø§ÙØ²ÙˆØ¯Ù† Ù¾Ø§Ø±Ú†Ù‡ ${nextOrdinal}`;
    }

    previewBtn.disabled = !(cur && cur.tags.length>0);

    const selTitle = document.getElementById('selTitle');
    if(selTitle) selTitle.textContent = `Ø§Ù†ØªØ®Ø§Ø¨ Ù¾Ø§Ø±Ú†Ù‡ ${faOrdinal(i+1)}`;

    if(cur && cur.url){ fabMini.src=cur.url; fabMini.style.visibility='visible'; }
    else { fabMini.style.visibility='hidden'; }
  }

  function addOverlay(x,y,url){
    const d=document.createElement('div');
    d.className='overlay';
    d.style.left=(x*100)+'%';
    d.style.top=(y*100)+'%';
    d.style.backgroundImage=`url(${url})`;
    tagFrame.appendChild(d);
  }
  function redraw(){
    tagFrame.querySelectorAll('.overlay').forEach(n=>n.remove());
    fabrics.forEach(f=> f.tags.forEach(t=> addOverlay(t.x,t.y,f.url)) );
  }

  photoFile.addEventListener('change', e=>{
    const f=e.target.files?.[0]; if(!f) return;
    photoOk=true;
    loadBase(f);
    goNext.disabled=true;
    baseImg.onload = ()=>{ goNext.disabled=false; };
  });
  photoCam.addEventListener('change', ()=>photoFile.dispatchEvent(new Event('change')));
  goNext.addEventListener('click', ()=>{ if(photoOk) toFabs(); });

  prevBtn.addEventListener('click', ()=>{ if(i>0){ i--; updateUI(); } else { toUpload(); } });
  nextBtn.addEventListener('click', ()=>{ if(i<fabrics.length-1){ i++; updateUI(); } });

  fabFile.addEventListener('change', e=>{ const f=e.target.files?.[0]; if(!f) return; setFabricFromFile(f); });
  fabCam .addEventListener('change', e=>{ const f=e.target.files?.[0]; if(!f) return; setFabricFromFile(f); });

  addBtn.addEventListener('click', ()=>{
    if(addBtn.disabled) return;
    fabrics.push({id:fabrics.length,url:'',quality:'standard',tags:[]});
    i=fabrics.length-1; updateUI();
  });

  qToggle.addEventListener('click', e=>{
    const b=e.target.closest('button'); if(!b||!fabrics[i]) return;
    [...qToggle.children].forEach(x=>x.classList.toggle('active',x===b));
    fabrics[i].quality=b.dataset.q;
  });
  previewBtn.addEventListener('click', ()=>{
    alert(`(Ø¯Ù…Ùˆ) Ù¾ÛŒØ´â€ŒÙ†Ù…Ø§ÛŒØ´ Ú©ÙˆØ³Ù† â€” Ù¾Ø§Ø±Ú†Ù‡ ${i+1} â€” Ú©ÛŒÙÛŒØª: ${fabrics[i].quality||'standard'}`);
  });

  const tagFrameEl=document.getElementById('tagFrame');
  tagFrameEl.addEventListener('click', e=>{
    if(!fabrics[i] || !fabrics[i].url) return;
    const r=tagFrameEl.getBoundingClientRect();
    const x=(e.clientX-r.left)/r.width, y=(e.clientY-r.top)/r.height;
    fabrics[i].tags.push({x,y});
    addOverlay(x,y,fabrics[i].url);
    updateUI();
  });

  undoBtn.addEventListener('click', ()=>{
    if(!fabrics[i] || fabrics[i].tags.length===0) return;
    fabrics[i].tags.pop(); redraw(); updateUI();
  });
  clearBtn.addEventListener('click', ()=>{
    if(!fabrics[i]) return;
    fabrics[i].tags=[]; redraw(); updateUI();
  });
</script>
</body>
</html>
