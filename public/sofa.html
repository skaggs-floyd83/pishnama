<!doctype html>
<html lang="fa" dir="rtl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>Ù¾ÛŒØ´Ù†Ù…Ø§ â€” Ù…Ø¨Ù„ (v3)</title>
<style>
  :root{--bg:#0b1020;--card:#0f162b;--muted:#94a3b8;--text:#e5e7eb;--border:#243045;--accent:#22c55e;--blue:#1f3a8a}
  html,body{margin:0;background:var(--bg);color:var(--text);font-family:Vazirmatn,IRANSans,Segoe UI,Roboto,Arial}
  .wrap{max-width:480px;margin:0 auto;height:100svh;display:flex;flex-direction:column}
  .bar{position:relative;padding:10px 14px;display:flex;justify-content:flex-start;align-items:center}
  .hamburger{border:1px solid var(--border);background:#0f1a33;color:#e2e8f0;border-radius:10px;padding:8px 12px;cursor:pointer}
  .menu{position:absolute;top:48px;right:14px;background:var(--card);border:1px solid var(--border);border-radius:12px;min-width:180px;display:none;flex-direction:column;overflow:hidden;z-index:10}
  .menu a{padding:10px 12px;color:#e5e7eb;text-decoration:none;border-bottom:1px solid var(--border);display:block}
  .menu a:last-child{border-bottom:0}
  .menu.show{display:flex}
  .card{background:var(--card);border:1px solid var(--border);border-radius:14px;padding:12px;margin:10px}
  .row{display:flex;align-items:center;gap:8px}
  .btn{border:1px solid var(--border);background:#0f1a33;color:#e2e8f0;border-radius:12px;padding:10px 14px;cursor:pointer}
  .btn.primary{background:var(--blue);border-color:var(--blue)}
  .btn:disabled{opacity:.5;cursor:not-allowed}
  .thumb{position:relative;display:flex;align-items:center;justify-content:center;border:1px dashed var(--border);border-radius:12px;min-height:120px;background:#0f172a;overflow:hidden}
  .thumb img{max-width:100%;max-height:100%;width:auto;height:auto;display:block}
  .badge{position:absolute;top:8px;right:8px;background:#0f1a33;border:1px solid var(--border);border-radius:999px;padding:4px 10px;font-size:.85rem;color:#e5e7eb}
  .toggle{display:inline-flex;border:1px solid var(--border);border-radius:999px;overflow:hidden}
  .toggle button{border:0;background:transparent;color:#cbd5e1;padding:8px 12px}
  .toggle .active{background:#0f1a33;color:#fff}
  .schem{display:grid;grid-template-columns:repeat(4,1fr);gap:8px;margin-top:6px}
  .part{height:54px;border:1px solid var(--border);border-radius:10px;background:#0f1a33;display:grid;place-items:center}
  .part.active{background:#0e3a2b;border-color:#0e3a2b}
  .viewport{flex:1;display:flex;flex-direction:column;gap:10px;overflow:hidden}
  .section{display:none;flex:1;overflow:hidden}
  .section.active{display:flex;flex-direction:column}
  .controls{margin:0 10px;display:flex;flex-direction:column;gap:10px;flex:1}
  .rightline{display:flex;justify-content:flex-start;align-items:center}
  .between{display:flex;justify-content:space-between;align-items:center}
  #sofaThumb, #frame .thumb { height: 220px !important; width: 100%; }
  #navRow{margin:0 10px;display:flex;justify-content:space-between;align-items:center}
  .tagsHeader{margin-top:14px;margin-bottom:6px;font-size:.95rem;color:var(--muted);}
</style>
</head>
<body>
<div class="wrap">
  <div class="bar">
    <button class="hamburger" id="hambtn">â˜°</button>
    <div class="menu" id="menu">
      <a href="sofa.html">ğŸ›‹ï¸ Ø·Ø±Ø§Ø­ÛŒ Ù…Ø¨Ù„</a>
      <a href="pillows.html">ğŸ›‹ï¸ Ø·Ø±Ø§Ø­ÛŒ Ú©ÙˆØ³Ù†â€ŒÙ‡Ø§</a>
    </div>
  </div>

  <div class="viewport">
    <!-- STEP 1 -->
    <section id="step-upload" class="section active">
      <div class="card">
        <h3 style="margin:0 0 8px">ğŸ“· Ø¢Ù¾Ù„ÙˆØ¯ Ù…Ø¨Ù„</h3>
        <div class="thumb" id="sofaThumb"><span class="hint">Ù‡Ù†ÙˆØ² ØªØµÙˆÛŒØ±ÛŒ Ø§Ù†ØªØ®Ø§Ø¨ Ù†Ø´Ø¯Ù‡</span></div>
      </div>
      <div class="controls">
        <div class="row between">
          <div class="row">
            <label class="btn">ğŸ“<input id="sofaFile" type="file" accept="image/*" hidden></label>
            <label class="btn">ğŸ“·<input id="sofaCam" type="file" accept="image/*" capture="environment" hidden></label>
          </div>
          <button class="btn primary" id="toFabricsBtn" disabled>Ø§Ø¯Ø§Ù…Ù‡ â—€</button>
        </div>
      </div>
    </section>

    <!-- STEP 2 -->
    <section id="step-fabrics" class="section">
      <div class="row" id="navRow">
        <button class="btn" id="prevStep">Ù‚Ø¨Ù„ÛŒ â–¶</button>
        <button class="btn" id="nextBtn">â—€ Ø¨Ø¹Ø¯ÛŒ</button>
      </div>

      <div class="card" id="frame">
        <div class="thumb">
          <span class="badge" id="wizBadge">Ù¾Ø§Ø±Ú†Ù‡ 1 Ø§Ø² 1</span>
          <span id="fabPlaceholder" style="position:absolute;color:var(--muted);font-size:.95rem">Ù¾Ø§Ø±Ú†Ù‡ Ø§ÙˆÙ„ Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯</span>
          <img id="fabImg" alt="">
        </div>

        <div class="rightline" style="margin-top:10px; margin-bottom:8px; gap:8px">
          <label class="btn">ğŸ“<input id="fabFile" type="file" accept="image/*" hidden></label>
          <label class="btn">ğŸ“·<input id="fabCam" type="file" accept="image/*" capture="environment" hidden></label>
        </div>

        <div class="tagsHeader">Ø¨Ø®Ø´ Ù…Ø±Ø¨ÙˆØ·Ù‡</div>
        <div class="schem" id="schem">
          <button class="part" data-part="back">Ù¾Ø´ØªÛŒ</button>
          <button class="part" data-part="seat">Ù†Ø´ÛŒÙ…Ù†</button>
          <button class="part" data-part="arms">Ø¯Ø³ØªÙ‡â€ŒÙ‡Ø§</button>
          <button class="part" data-part="all">Ù‡Ù…Ù‡</button>
        </div>
      </div>

      <div class="controls">
        <div class="rightline">
          <button class="btn" id="addBtn">â• Ø§ÙØ²ÙˆØ¯Ù† Ù¾Ø§Ø±Ú†Ù‡ Ø¯ÙˆÙ…</button>
        </div>
      </div>

      <div class="controls">
        <div class="rightline" style="gap:8px">
          <div class="toggle" id="qToggle">
            <button class="active" data-q="standard">Ú©ÛŒÙÛŒØª Ù…Ø¹Ù…ÙˆÙ„ÛŒ</button>
            <button data-q="high">Ú©ÛŒÙÛŒØª Ø¨Ø§Ù„Ø§</button>
          </div>
          <button class="btn primary" id="previewBtn" disabled>âœ¨ Ù¾ÛŒØ´â€ŒÙ†Ù…Ø§ÛŒØ´</button>
        </div>
      </div>
    </section>
  </div>
</div>

<script>
  function faOrdinal(n){ return n===1?'Ø§ÙˆÙ„':(n===2?'Ø¯ÙˆÙ…':'Ø³ÙˆÙ…'); }

  // Hamburger
  const hambtn=document.getElementById('hambtn');
  const menu=document.getElementById('menu');
  hambtn.addEventListener('click', ()=> menu.classList.toggle('show'));
  document.addEventListener('click', (e)=>{ if(!menu.contains(e.target) && e.target!==hambtn) menu.classList.remove('show'); });

  // Elements
  const sofaFile=document.getElementById('sofaFile');
  const sofaCam=document.getElementById('sofaCam');
  const sofaThumb=document.getElementById('sofaThumb');
  const toFabricsBtn=document.getElementById('toFabricsBtn');
  const stepUpload=document.getElementById('step-upload');
  const stepFabrics=document.getElementById('step-fabrics');

  const fabFile=document.getElementById('fabFile');
  const fabCam=document.getElementById('fabCam');
  const fabImg=document.getElementById('fabImg');
  const wizBadge=document.getElementById('wizBadge');
  const qToggle=document.getElementById('qToggle');
  const schem=document.getElementById('schem');
  const previewBtn=document.getElementById('previewBtn');
  const addBtn=document.getElementById('addBtn');
  const nextBtn=document.getElementById('nextBtn');
  const prevStep=document.getElementById('prevStep');
  const parts=['back','seat','arms'];

  // State
  let sofaChosen=false;
  let fabrics=[]; // {id,url,quality:'standard',parts:Set}
  let assigned={back:null,seat:null,arms:null};
  let idx=0;

  function loadImage(el,file){ const url=URL.createObjectURL(file); el.src=url; el.onload=()=>URL.revokeObjectURL(url); }
  function gotoUpload(){ stepFabrics.classList.remove('active'); stepUpload.classList.add('active'); }
  function gotoFabrics(){ stepUpload.classList.remove('active'); stepFabrics.classList.add('active'); updateUI(); }

  function updateUI(){
    if(!fabrics[idx]) return;
    const cur=fabrics[idx];

    fabImg.src=cur.url||'';
    wizBadge.textContent=`Ù¾Ø§Ø±Ú†Ù‡ ${idx+1} Ø§Ø² ${fabrics.length}`;
    const ph=document.getElementById('fabPlaceholder');
    if(cur.url){ ph.style.display='none'; } else { ph.textContent=`Ù¾Ø§Ø±Ú†Ù‡ ${faOrdinal(idx+1)} Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯`; ph.style.display='block'; }

    schem.querySelectorAll('.part').forEach(btn=>{
      const p=btn.dataset.part;
      if(p==='all'){
        const allAvail=parts.every(pa=>(assigned[pa]===null||assigned[pa]===cur.id));
        btn.style.visibility=allAvail?'visible':'hidden';
        btn.classList.toggle('active',cur.parts.size===3);
      }else{
        const visible=(assigned[p]===null||assigned[p]===cur.id);
        btn.style.visibility=visible?'visible':'hidden';
        btn.classList.toggle('active',cur.parts.has(p));
      }
    });

    previewBtn.disabled=(cur.parts.size===0);

    // Add button: dynamic text and visibility
    if(fabrics.length>=3){
      addBtn.style.display='none';
    }else{
      addBtn.style.display='inline-block';
      const nextOrdinal=faOrdinal(Math.min(fabrics.length+1,3));
      addBtn.textContent=`â• Ø§ÙØ²ÙˆØ¯Ù† Ù¾Ø§Ø±Ú†Ù‡ ${nextOrdinal}`;

      const allAssignedOverall=parts.every(p=>assigned[p]!==null);
      const curAll=(cur.parts.size===3);
      const currentReady=!!cur.url&&cur.parts.size>0;
      addBtn.disabled=allAssignedOverall||curAll||!currentReady;
    }

    // Next button visible; disabled if no next
    nextBtn.style.display='inline-block';
    nextBtn.disabled = !(idx < fabrics.length-1);
  }

  prevStep.addEventListener('click', ()=>{ if(idx>0){ idx--; updateUI(); } else { gotoUpload(); }});
  nextBtn.addEventListener('click', ()=>{ if(idx<fabrics.length-1){ idx++; updateUI(); }});

  addBtn.addEventListener('click', ()=>{
    if(addBtn.disabled) return;
    fabrics.push({id:fabrics.length,url:'',quality:'standard',parts:new Set()});
    idx=fabrics.length-1;
    updateUI();
  });

  sofaFile.addEventListener('change', e=>{
    const f=e.target.files?.[0]; if(!f) return;
    sofaChosen=true;
    toFabricsBtn.disabled=false;
    sofaThumb.innerHTML='<img>';
    loadImage(sofaThumb.firstElementChild,f);
    if(fabrics.length===0) fabrics.push({id:0,url:'',quality:'standard',parts:new Set()});
    idx=0;
  });
  sofaCam.addEventListener('change', ()=>sofaFile.dispatchEvent(new Event('change')));
  toFabricsBtn.addEventListener('click', ()=>{ if(!sofaChosen) return; gotoFabrics(); });

  function setFabricFromFile(file){
    const url=URL.createObjectURL(file);
    fabrics[idx].url=url;
    fabImg.src=url;
    updateUI();
  }
  fabFile.addEventListener('change', e=>{ const f=e.target.files?.[0]; if(!f) return; setFabricFromFile(f); });
  fabCam .addEventListener('change', e=>{ const f=e.target.files?.[0]; if(!f) return; setFabricFromFile(f); });

  qToggle.addEventListener('click', e=>{
    const b=e.target.closest('button'); if(!b||!fabrics[idx]) return;
    [...qToggle.children].forEach(x=>x.classList.toggle('active',x===b));
    fabrics[idx].quality=b.dataset.q;
  });

  schem.addEventListener('click', e=>{
    const btn=e.target.closest('.part'); if(!btn||!fabrics[idx]) return;
    const p=btn.dataset.part;
    const cur=fabrics[idx];
    if(p==='all'){
      const allAvail=parts.every(pa=>(assigned[pa]===null||assigned[pa]===cur.id));
      if(!allAvail) return;
      const turnOn=(cur.parts.size!==3);
      parts.forEach(pa=>{
        if(turnOn){ cur.parts.add(pa); assigned[pa]=cur.id; }
        else{ cur.parts.delete(pa); if(assigned[pa]===cur.id) assigned[pa]=null; }
      });
    }else{
      const visible=(assigned[p]===null||assigned[p]===cur.id);
      if(!visible) return;
      if(cur.parts.has(p)){ cur.parts.delete(p); if(assigned[p]===cur.id) assigned[p]=null; }
      else { cur.parts.add(p); assigned[p]=cur.id; }
    }
    updateUI();
  });

  previewBtn.addEventListener('click', ()=>{
    const q=fabrics[idx].quality||'standard';
    alert(`(Ø¯Ù…Ùˆ) Ù¾ÛŒØ´â€ŒÙ†Ù…Ø§ÛŒØ´ Ù…Ø¨Ù„ â€” Ù¾Ø§Ø±Ú†Ù‡ ${idx+1} â€” Ú©ÛŒÙÛŒØª: ${q}`);
  });
</script>
</body>
</html>
