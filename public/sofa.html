<!doctype html>
<!--
  Project: Pishnama â€” Sofa Fabric Assignment (Developer-Commented Copy)
  File: sofa_commented_dev.html
  Purpose:
    Two-stage flow to upload a sofa image and assign up to THREE fabrics to specific parts
    of the sofa (back/seat/arms). Uses pure HTML/CSS/vanilla JS. No network calls here.

  Key UX decisions (preserve behavior exactly):
    â€¢ Hamburger is icon-only (â˜°). Menu contains links to sofa & pillows pages.
    â€¢ File selection buttons are icon-only (ğŸ“ for choose file, ğŸ“· for camera).
    â€¢ Stages:
        1) Upload: user selects base sofa image; "Continue" becomes enabled after image loads.
        2) Fabrics: user iterates through per-fabric context and assigns fabric to parts.
    â€¢ Up to 3 fabrics are supported. The "Add Fabric" button:
        â€“ Shows â€œâ• Ø§ÙØ²ÙˆØ¯Ù† Ù¾Ø§Ø±Ú†Ù‡ {Ø¯ÙˆÙ…|Ø³ÙˆÙ…}â€ (dynamic ordinal)
        â€“ Is completely HIDDEN when three fabrics already exist (NOT disabled).
    â€¢ Placeholder text â€œÙ¾Ø§Ø±Ú†Ù‡ {Ø§ÙˆÙ„|Ø¯ÙˆÙ…|Ø³ÙˆÙ…} Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯â€ appears inside the preview
      until the current fabric image is set.
    â€¢ â€œØ¨Ø®Ø´ Ù…Ø±Ø¨ÙˆØ·Ù‡â€ (part grid) controls assignment; a fabric can own any subset of parts.
      Visibility rules prevent conflicting assignments across fabrics.
    â€¢ â€œNextâ€ is always rendered (visible) but disabled when there is no next fabric.
    â€¢ â€œPreviewâ€ enables only when at least one part is selected for the current fabric.
  Notes for future devs:
    â€¢ Blob URLs (createObjectURL) are used for local previews; revoke on <img> load where applicable.
    â€¢ This page is self-contained UI only; model integration should be added where Preview is handled.
-->
<html lang="fa" dir="rtl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>Ù¾ÛŒØ´Ù†Ù…Ø§ â€” Ù…Ø¨Ù„ (v3, commented)</title>
<style>
  :root{--bg:#0b1020;--card:#0f162b;--muted:#94a3b8;--text:#e5e7eb;--border:#243045;--accent:#22c55e;--blue:#1f3a8a}
  html,body{margin:0;background:var(--bg);color:var(--text);font-family:Vazirmatn,IRANSans,Segoe UI,Roboto,Arial}
  .wrap{max-width:480px;margin:0 auto;min-height:100svh;/* replaced */ height:auto;/* added */display:flex;flex-direction:column}
  .bar{position:relative;padding:10px 14px;display:flex;justify-content:flex-start;align-items:center}
  /* Icon-only hamburger; text "Ù…Ù†Ùˆ" intentionally removed */
  .hamburger{border:1px solid var(--border);background:#0f1a33;color:#e2e8f0;border-radius:10px;padding:8px 12px;cursor:pointer}
  .menu{position:absolute;top:48px;right:14px;background:var(--card);border:1px solid var(--border);border-radius:12px;min-width:180px;display:none;flex-direction:column;overflow:hidden;z-index:10}
  .menu a{padding:10px 12px;color:#e5e7eb;text-decoration:none;border-bottom:1px solid var(--border);display:block}
  .menu a:last-child{border-bottom:0}
  .menu.show{display:flex}

  .card{background:var(--card);border:1px solid var(--border);border-radius:14px;padding:12px;margin:10px}
  .row{display:flex;align-items:center;gap:8px}
  .btn{border:1px solid var(--border);background:#0f1a33;color:#e2e8f0;border-radius:12px;padding:10px 14px;cursor:pointer}
  .btn.primary{background:var(--blue);border-color:var(--blue)}
  .btn:disabled{opacity:.5;cursor:not-allowed}

  /* Generic image frame for previews/placeholders */
  .thumb{position:relative;display:flex;align-items:center;justify-content:center;border:1px solid var(--border);border-radius:12px;min-height:120px;background:#0f172a;overflow:hidden}
  .thumb img{max-width:100%;max-height:100%;width:auto;height:auto;display:block}
  .badge{position:absolute;top:8px;right:8px;background:#0f1a33;border:1px solid var(--border);border-radius:999px;padding:4px 10px;font-size:.85rem;color:#e5e7eb}

  /* Quality toggle (two-state) */
  .toggle{display:inline-flex;border:1px solid var(--border);border-radius:999px;overflow:hidden}
  .toggle button{border:0;background:transparent;color:#cbd5e1;padding:8px 12px}
  .toggle .active{background:#193a88;color:#fff}

  /* Part grid â€œØ¨Ø®Ø´ Ù…Ø±Ø¨ÙˆØ·Ù‡â€: back/seat/arms/all */
  .schem{display:grid;grid-template-columns:repeat(4,1fr);gap:8px;margin-top:6px;align-items: center;}
  .part{height:54px;border:1px solid var(--border);border-radius:10px;background:#0f1a33;display:grid;place-items:center}
  .part.active{background:#0e3a2b;border-color:#0e3a2b}
  /* Keep a visible border when the All Parts tag is selected */
  .part[data-part="all"].active {
    border-color: var(--border);   /* same color as unselected state */
    border-width: 6px;             /* keep your thick border */
  }
  /* Make "All Parts" slightly wider with a thick border */
  .part[data-part="all"] {
    height: 68px;        /* instead of the default 54px */
    padding-inline: 44px;   /* makes it visually wider */
    border-width: 6px;      /* very thick border */
  }

  .viewport{flex:1;display:flex;flex-direction:column;gap:10px;overflow:auto/*replaced*/}
  .section{display:none;flex:1;overflow:auto/*replaced*/}
  .section.active{display:flex;flex-direction:column}

  .controls{margin:0 10px;display:flex;flex-direction:column;gap:10px;flex:1}
  .rightline{display:flex;justify-content:flex-start;align-items:center}
  .between{display:flex;justify-content:space-between;align-items:center}

  /* Fabric selection frame borrowed from pillows layout */
  .selectFrame{border:1px solid var(--border);border-radius:12px;padding:10px;background:#0f172a;display:flex;flex-direction:column;gap:10px;position:relative}

  /* Fixed heights used in mobile-safe viewport */
  #sofaThumb, #baseFrame { height: 220px !important; width: 100%; }
  #navRow{margin:0 10px;display:flex;justify-content:space-between;align-items:center}
  .tagsHeader{margin-top:14px;margin-bottom:6px;font-size:.95rem;color:var(--muted);}

  /* Tiny remove icon inside fabric frame */
  .tinyX{position:absolute;left:8px;top:8px;background:#0f1a33;border:1px solid var(--border);border-radius:8px;padding:4px 6px;cursor:pointer;font-size:14px;line-height:1}
  .tinyX:hover{background:#17213d}
  /* Toast */
  #toast{position:fixed;left:50%;transform:translateX(-50%);bottom:20px;background:#0f1a33;border:1px solid var(--border);color:#e5e7eb;padding:8px 12px;border-radius:10px;opacity:0;transition:opacity .25s;pointer-events:none;z-index:9999}
  #toast.show{opacity:1}

</style>
<script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>
</head>
<body>
<div class="wrap">
  <!-- Header: hamburger only -->
  <div class="bar">
    <button class="hamburger" id="hambtn">â˜°</button>
    <button class="btn" id="loginBtn" style="margin-right:10px; direction: ltr;">ÙˆØ±ÙˆØ¯</button>
    <span id="credit-info" style="margin-right:10px;font-size:14px;"></span>
    <button class="btn" id="buyCreditsBtn" style="margin-right:10px; display:none;">
      ğŸ’³ Ø®Ø±ÛŒØ¯ Ø§Ø¹ØªØ¨Ø§Ø±
    </button>




    <div id="userMenu" 
     style="position:absolute; top:50px; right:10px; 
            background:#0f1629; border:1px solid #3a4367; 
            padding:10px; border-radius:8px; width:140px; 
            display:none; z-index:9999;">

      <button id="logoutBtn" 
              class="btn" 
              style="width:100%; background:#3a4367;">
          Ø®Ø±ÙˆØ¬
      </button>
    </div>

    <div class="menu" id="menu">
      <a href="sofa.html">ğŸ›‹ï¸ Ø·Ø±Ø§Ø­ÛŒ Ù…Ø¨Ù„</a>
      <a href="pillows.html">ğŸ›‹ï¸ Ø·Ø±Ø§Ø­ÛŒ Ø¨Ø§Ù„Ø´ØªÚ© Ù‡Ø§</a>
    </div>
  </div>

  <div class="viewport">
    <!-- ===== Stage 1: Upload base sofa image ===== -->
    <section id="step-upload" class="section active">
      <div class="card">
        <h3 style="margin:0 0 8px">ğŸ“· Ø¢Ù¾Ù„ÙˆØ¯ ØªØµÙˆÛŒØ± Ù…Ø¨Ù„</h3>
        <div class="thumb" id="sofaThumb">
          <!-- <span class="hint">Ù‡Ù†ÙˆØ² ØªØµÙˆÛŒØ±ÛŒ Ø§Ù†ØªØ®Ø§Ø¨ Ù†Ø´Ø¯Ù‡</span> -->
        </div>

        <div class="controls" style="margin-top: 8px;margin-right: 0px;margin-left: 0px;">
        <div class="row between">
          <!-- Icon-only file/camera per product decision -->
          <div class="row">
            <label class="btn" title="Ø§Ù†ØªØ®Ø§Ø¨ ÙØ§ÛŒÙ„">ğŸ“<input id="sofaFile" type="file" accept="image/*" hidden></label>
            <label class="btn" title="Ø¯ÙˆØ±Ø¨ÛŒÙ†">ğŸ“·<input id="sofaCam" type="file" accept="image/*" capture="environment" hidden></label>
          </div>
          <!-- Continue becomes enabled only after the image loads -->
          <button class="btn primary" id="toFabricsBtn" disabled>Ø§Ø¯Ø§Ù…Ù‡ â—€</button>
        </div>
      </div>

      </div>

    </section>

    <!-- ===== Stage 2: Fabric selection + part assignment ===== -->
    <section id="step-fabrics" class="section">
      <!-- Navigation row: â€œPrevâ€ always goes back to stage 1 if idx==0; â€œNextâ€ is visible but disabled if no next -->
      <div class="row" id="navRow">
        <button class="btn" id="prevStep">Ù‚Ø¨Ù„ÛŒ â–¶</button>
        <button class="btn" id="nextBtn">â—€ Ø¨Ø¹Ø¯ÛŒ</button>
      </div>

      <div class="card" id="frame">
        <!-- Stage 2 base sofa frame mirrors pillows layout -->
        <div class="thumb" id="baseFrame" style="margin-bottom: 15px;">
          <img id="baseImg2" alt="">
        </div>

        <!-- Fabric selection frame with thumbnail + controls -->
        <div class="selectFrame">
          <button class="tinyX" id="removeFabBtn" title="Ø­Ø°Ù Ù¾Ø§Ø±Ú†Ù‡">ğŸ—‘ï¸</button>
          <!-- I commented this line and the related codes - I will probably delete it in the future (search wizBadge to find related codes) -->
          <!-- <span class="badge" id="wizBadge" style="display: none;">Ù¾Ø§Ø±Ú†Ù‡ 1 Ø§Ø² 1</span> -->
          <div class="row" style="justify-content:flex-start;width:100%">
            <strong id="selTitle" style="color:var(--muted);font-size:.95rem;">Ø§Ù†ØªØ®Ø§Ø¨ Ù¾Ø§Ø±Ú†Ù‡ Ø§ÙˆÙ„</strong>
          </div>
          <div class="row" style="justify-content:space-between;width:100%">
            <div class="rightline" style="gap:8px">
              <label class="btn" title="Ø¢Ù¾Ù„ÙˆØ¯ Ù¾Ø§Ø±Ú†Ù‡">ğŸ“<input id="fabFile" type="file" accept="image/*" hidden></label>
              <label class="btn" title="Ø¯ÙˆØ±Ø¨ÛŒÙ†">ğŸ“·<input id="fabCam" type="file" accept="image/*" capture="environment" hidden></label>
            </div>
            <img id="fabImg" alt="" style="width:36px;height:36px;border-radius:8px;border:1px solid var(--border);object-fit:cover;background:#0f172a;visibility:hidden">
          </div>
          <!-- I commented this line and the related codes - I will probably delete it in the future (search fabPlaceholder to find related codes) -->
          <!-- <span id="fabPlaceholder" style="color:var(--muted);font-size:.9rem;display:block;">Ù¾Ø§Ø±Ú†Ù‡ Ø§ÙˆÙ„ Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯</span> -->
          <div>
            <div class="tagsHeader" style="margin-top:0">Ø¨Ø®Ø´ Ù…Ø±Ø¨ÙˆØ· Ø¨Ù‡ Ø§ÛŒÙ† Ù¾Ø§Ø±Ú†Ù‡</div>
            <div class="schem" id="schem">
              <button class="part" data-part="all" style="color: #e2e8f0;">Ù‡Ù…Ù‡</button>
              <button class="part" data-part="back" style="color: #e2e8f0;">Ù¾Ø´ØªÛŒ</button>
              <button class="part" data-part="seat" style="color: #e2e8f0;">Ù†Ø´ÛŒÙ…Ù†</button>
              <button class="part" data-part="arms" style="color: #e2e8f0;">Ø¯Ø³ØªÙ‡â€ŒÙ‡Ø§</button>
              
            </div>
          </div>
        </div>

        <!-- Add Fabric: HIDDEN when fabrics.length >= 3; otherwise enabled based on selection readiness -->
        <div class="controls">
          <div class="rightline" style="margin-top: 10px;">
            <button class="btn" id="addBtn">â• Ø§ÙØ²ÙˆØ¯Ù† Ù¾Ø§Ø±Ú†Ù‡ Ø¯ÙˆÙ…</button>
          </div>
        </div>

      </div>



      <!-- Generate row: quality toggle + preview (integration point for the model) -->
      <div class="controls">
        <div class="rightline" style="gap:8px; margin-bottom: 20px; margin-top: 10px;">
          <div class="toggle" id="qToggle" style="margin-left: 10px;">
            <button class="active" data-q="high">Ù‡ÙˆØ´ ÛŒÚ© &nbsp; (2 Ø³Ú©Ù‡)</button>
            <button data-q="standard">Ù‡ÙˆØ´ Ø¯Ùˆ &nbsp; (1 Ø³Ú©Ù‡)</button>
          </div>
          <button class="btn primary" id="previewBtn">âœ¨ Ø¨Ø³Ø§Ø²</button>
        </div>
      </div>
    </section>
  </div>
</div>

<script>
/* =============================================================================
   Pishnama â€” Sofa Page (Inline Script, Refactored)
   Scope: Internal modularization & comments ONLY â€” ZERO behavior/UI changes
   Notes:
     - Public IDs/classes and Persian text are untouched.
     - Structure: Typedefs â†’ Constants/DOM â†’ State â†’ Helpers â†’ Core UI Sync
                  â†’ Validation/Export â†’ Handlers â†’ Event Bindings â†’ Init
============================================================================= */

/** ============================================================================
 * Typedefs (documentation only)
 * @typedef {{ id:number, url:string, file?:File, parts:Set<'back'|'seat'|'arms'> }} Fabric
 * @typedef {{ back:number|null, seat:number|null, arms:number|null }} Assigned
 * ========================================================================== */

/* ============================== Constants / DOM ============================ */

function displayPhone(identifier) {
    // Convert +989123456789 â†’ 09123456789
    if (identifier.startsWith("+98") && identifier.length === 13) {
        return "0" + identifier.slice(3);
    }
    return identifier; // email or unexpected case
}

function updateLoginButton() {
    const btn = document.getElementById("loginBtn");
    if (!btn) return;

    const token = localStorage.getItem("pishnama_user_token");
    const identifier = localStorage.getItem("pishnama_user_identifier");
    const buyCreditsBtn = document.getElementById("buyCreditsBtn");
    
    if (token) {
      buyCreditsBtn.style.display = "inline-block";
    } else {
      buyCreditsBtn.style.display = "none";
    }


    if (token && identifier) {
        // User is logged in
        btn.textContent = displayPhone(identifier);
        btn.disabled = false;      // optional: prevent modal opening
        btn.style.opacity = "0.8";
    } else {
        // User is not logged in
        btn.textContent = "ÙˆØ±ÙˆØ¯";
        btn.disabled = false;
        btn.style.opacity = "1";
        userMenu.style.display = "none";
    }

    




}

function forceLogoutIfInvalid(tokenResponse) {
    if (tokenResponse && tokenResponse.error === "login_required") {
        // Remove invalid credentials
        localStorage.removeItem("pishnama_user_token");
        localStorage.removeItem("pishnama_user_identifier");

        // Update UI
        updateLoginButton();

        // Inform the user
        showToast("Ù†Ø´Ø³Øª Ú©Ø§Ø±Ø¨Ø±ÛŒ Ø´Ù…Ø§ Ù…Ù†Ù‚Ø¶ÛŒ Ø´Ø¯Ù‡ Ø§Ø³Øª. Ù„Ø·ÙØ§Ù‹ Ø¯ÙˆØ¨Ø§Ø±Ù‡ ÙˆØ§Ø±Ø¯ Ø´ÙˆÛŒØ¯.");

        return true;  // indicates logout happened
    }
    return false;
}


// Maps 1..3 to Persian ordinals: Ø§ÙˆÙ„ / Ø¯ÙˆÙ… / Ø³ÙˆÙ…
function faOrdinal(n){ return n===1?'Ø§ÙˆÙ„':(n===2?'Ø¯ÙˆÙ…':'Ø³ÙˆÙ…'); }

// Hamburger
const hambtn   = document.getElementById('hambtn');
const menu     = document.getElementById('menu');

// Stage 1 (Upload)
const sofaFile     = document.getElementById('sofaFile');
const sofaCam      = document.getElementById('sofaCam');
const sofaThumb    = document.getElementById('sofaThumb');
const toFabricsBtn = document.getElementById('toFabricsBtn');
const stepUpload   = document.getElementById('step-upload');

// Stage 2 (Fabrics)
const stepFabrics  = document.getElementById('step-fabrics');
const baseImg2     = document.getElementById('baseImg2');
const fabFile      = document.getElementById('fabFile');
const fabCam       = document.getElementById('fabCam');
const fabImg       = document.getElementById('fabImg');
const selTitle     = document.getElementById('selTitle');
// const wizBadge     = document.getElementById('wizBadge');
const qToggle      = document.getElementById('qToggle');
const schem        = document.getElementById('schem');
const previewBtn   = document.getElementById('previewBtn');
const addBtn       = document.getElementById('addBtn');
const nextBtn      = document.getElementById('nextBtn');
const prevStep     = document.getElementById('prevStep');

// Logical part names; used for visibility rules and assignments
const parts = ['back','seat','arms'];

/* ================================== State ================================= */

// Global UI state (no persistence)
let sofaChosen   = false; // becomes true after an image is picked
/** @type {Fabric[]} */
let fabrics      = [];    // each item: { id, url, parts:Set<string> }
 /** @type {Assigned} */
let assigned     = {back:null, seat:null, arms:null}; // which fabric id owns each part (or null)
let idx          = 0;     // index of "current" fabric being edited
let sofaBaseFile = null;  // keep original base sofa File for export

// NEW: Global quality setting (standard | high)
let generationQuality = "high";

/* =============================== Helpers ================================== */

async function refreshCredits() {
  const token = localStorage.getItem("pishnama_user_token");
  if (!token) return;

  const res = await fetch("/api/credits", {
    headers: { "x-user-token": token }
  });

  if (!res.ok) return;

  const data = await res.json();
  
  const el = document.getElementById("credit-info");
  if (!el) return;

  if (data.credits_expires_at) {
    el.textContent = `Ø§Ø¹ØªØ¨Ø§Ø±: ${data.credits} (ØªØ§ ${new Date(data.credits_expires_at).toLocaleDateString("fa-IR")})`;
  } else {
    el.textContent = `Ø§Ø¹ØªØ¨Ø§Ø±: ${data.credits}`;
  }

}


/** Set <img>.src with a Blob URL; revoke URL after load to avoid leaks */
function loadImage(el, file){
  const url = URL.createObjectURL(file);
  el.src = url;
  el.onload = () => URL.revokeObjectURL(url);
}

// ======================= IMAGE COMPRESSION HELPERS =========================

const MAX_BASE_BYTES   = 3 * 1024 * 1024;  // 3 MB threshold for sofa base image
const MAX_FABRIC_BYTES = 3 * 1024 * 1024;  // 3 MB threshold for fabrics
const BASE_MAX_SIDE    = 1536;             // max width/height for sofa image
const FABRIC_MAX_SIDE  = 1024;             // max width/height for fabrics

function ensureJpegName(name) {
  if (!name) return "image.jpg";
  return name.replace(/\.[^.]+$/,"") + ".jpg";
}

/**
 * Load a File into an HTMLImageElement using a Blob URL.
 */
function loadFileToImage(file) {
  return new Promise((resolve, reject) => {
    const url = URL.createObjectURL(file);
    const img = new Image();
    img.onload = () => {
      URL.revokeObjectURL(url);
      resolve(img);
    };
    img.onerror = (err) => {
      URL.revokeObjectURL(url);
      reject(err);
    };
    img.src = url;
  });
}

/**
 * Compress & normalize an image *if needed*:
 *  - If JPEG and under maxBytes â†’ returned as-is
 *  - Otherwise â†’ resized to maxSide (inside) and encoded as JPEG,
 *    trying a few quality steps until under maxBytes (or quality floor).
 */
async function compressImageIfNeeded(file, { maxBytes, maxSide }) {
  // No need to touch small JPEGs
  if (file.type === "image/jpeg" && file.size <= maxBytes) {
    return file;
  }

  const img = await loadFileToImage(file);
  const longest = Math.max(img.width || maxSide, img.height || maxSide);
  const scale   = longest > maxSide ? (maxSide / longest) : 1;

  const targetW = Math.max(1, Math.round((img.width  || maxSide) * scale));
  const targetH = Math.max(1, Math.round((img.height || maxSide) * scale));

  const canvas = document.createElement("canvas");
  canvas.width  = targetW;
  canvas.height = targetH;

  const ctx = canvas.getContext("2d");
  ctx.drawImage(img, 0, 0, targetW, targetH);

  // Try a few qualities until we get under the threshold
  let quality = 0.85;
  let lastBlob = null;

  for (let i = 0; i < 4; i++) {
    const blob = await new Promise(resolve =>
      canvas.toBlob(resolve, "image/jpeg", quality)
    );
    if (!blob) break;
    lastBlob = blob;

    if (blob.size <= maxBytes || quality <= 0.6) {
      return new File([blob], ensureJpegName(file.name), { type: "image/jpeg" });
    }
    quality -= 0.1;
  }

  // Fallback: return best attempt if we never got under maxBytes
  if (lastBlob) {
    return new File([lastBlob], ensureJpegName(file.name), { type: "image/jpeg" });
  }
  // Ultimate fallback: original file
  return file;
}


/** Stage navigation (no side effects beyond DOM visibility) */
function gotoUpload(){
  stepFabrics.classList.remove('active');
  stepUpload.classList.add('active');
}
function gotoFabrics(){
  stepUpload.classList.remove('active');
  stepFabrics.classList.add('active');
  updateUI();
}

/* ============================== Core UI Sync ============================== */
/*
  Responsibilities:
    1) Update preview image + placeholder text
    2) Update part grid visibility/active states under conflicting assignments
    3) Manage â€œAdd Fabricâ€ (show/hide + label + enabled state)
    4) Keep â€œNextâ€ visible but disabled when there is no next fabric
    5) Enable Preview (generate) â€” validation happens on click
*/
function updateUI(){
  if(!fabrics[idx]) return;
  const cur = fabrics[idx];

  // 1) Preview (image or ordinal placeholder)
  fabImg.src = cur.url || '';
  fabImg.style.visibility = cur.url ? 'visible' : 'hidden';
  // const ph = document.getElementById('fabPlaceholder');
  // if(cur.url){ ph.style.display='none'; }
  // else { ph.textContent = `Ù¾Ø§Ø±Ú†Ù‡ ${faOrdinal(idx+1)} Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯`; ph.style.display='block'; }
  if(selTitle){ selTitle.textContent = `Ø§Ù†ØªØ®Ø§Ø¨ Ù¾Ø§Ø±Ú†Ù‡ ${faOrdinal(idx+1)}`; }

  // Wizard badge: "Ù¾Ø§Ø±Ú†Ù‡ X Ø§Ø² N"
  // wizBadge.textContent = `Ù¾Ø§Ø±Ú†Ù‡ ${idx+1} Ø§Ø² ${fabrics.length}`;

  // 2) Part grid visibility & active states
  schem.querySelectorAll('.part').forEach(btn=>{
    const p = btn.dataset.part;
    if(p==='all'){
      const allAvail = parts.every(pa => (assigned[pa]===null || assigned[pa]===cur.id));
      btn.style.visibility = allAvail ? 'visible' : 'hidden';
      btn.classList.toggle('active', cur.parts.size===3);
    }else{
      const visible = (assigned[p]===null || assigned[p]===cur.id);
      btn.style.visibility = visible ? 'visible' : 'hidden';
      btn.classList.toggle('active', cur.parts.has(p));
    }
  });

  // 5) Generate is always enabled; validation happens on click now
  previewBtn.disabled = false;

  // 3) Add Fabric management
  if(fabrics.length>=3){
    addBtn.style.display='none';
  }else{
    addBtn.style.display='inline-block';
    const nextOrdinal = faOrdinal(Math.min(fabrics.length+1,3));
    addBtn.textContent = `â• Ø§ÙØ²ÙˆØ¯Ù† Ù¾Ø§Ø±Ú†Ù‡ ${nextOrdinal}`;

    const allAssignedOverall = parts.every(p=>assigned[p]!==null);
    const curAll = (cur.parts.size===3);
    const currentReady = !!cur.url && cur.parts.size>0;
    addBtn.disabled = allAssignedOverall || curAll || !currentReady;
  }

  // 4) Next button: always present; disabled if there is no next fabric
  nextBtn.style.display='inline-block';
  nextBtn.disabled = !(idx < fabrics.length-1);
}

/* ===================== Validation (pre-generation) ======================== */

function validateBeforeGenerateSofa(){
  const errors = [];
  const warnings = [];

  // --- Mandatory checks ---
  if(!sofaChosen){
    errors.push("\n- ØªØµÙˆÛŒØ± Ù¾Ø§ÛŒÙ‡Ù” Ù…Ø¨Ù„ Ø§Ù†ØªØ®Ø§Ø¨ Ù†Ø´Ø¯Ù‡ Ø§Ø³Øª.");
  }
  const fabricsWithImg = fabrics.filter(f=>!!f.url);
  if(fabricsWithImg.length===0){
    errors.push("\n- Ø­Ø¯Ø§Ù‚Ù„ ÛŒÚ© ØªØµÙˆÛŒØ± Ù¾Ø§Ø±Ú†Ù‡ Ø¨Ø§ÛŒØ¯ Ø¢Ù¾Ù„ÙˆØ¯ Ø´ÙˆØ¯.");
  }
  const anyTaggedOnImg = fabrics.some(f=> !!f.url && f.parts && f.parts.size>0 );
  if(!anyTaggedOnImg){
    errors.push("\n- Ø­Ø¯Ø§Ù‚Ù„ ÛŒÚ© Ø¨Ø±Ú†Ø³Ø¨ Ø¨Ø®Ø´ (Ù¾Ø´ØªÛŒ/Ù†Ø´ÛŒÙ…Ù†/Ø¯Ø³ØªÙ‡â€ŒÙ‡Ø§) Ø¨Ø§ÛŒØ¯ Ø¨Ù‡ ÛŒÚ©ÛŒ Ø§Ø² Ù¾Ø§Ø±Ú†Ù‡â€ŒÙ‡Ø§ÛŒ Ø¢Ù¾Ù„ÙˆØ¯ Ø´Ø¯Ù‡ Ø§Ø®ØªØµØ§Øµ Ø¯Ø§Ø¯Ù‡ Ø´ÙˆØ¯.");
  }

  // --- Optional checks ---
  // A) Fabric images without any assigned parts
  const imgNoTags = fabrics
    .map((f,i)=>({f,i}))
    .filter(({f})=> !!f.url && (!f.parts || f.parts.size===0))
    .map(({i})=> `Ù¾Ø§Ø±Ú†Ù‡ ${faOrdinal(i+1)}`);
  if(imgNoTags.length>0){
    warnings.push("\n- Ø¨Ø±Ø§ÛŒ Ø¨Ø±Ø®ÛŒ Ù¾Ø§Ø±Ú†Ù‡â€ŒÙ‡Ø§ Ø¨Ø®Ø´ÛŒ ØªØ¹ÛŒÛŒÙ† Ù†Ø´Ø¯Ù‡ Ø§Ø³Øª: " + imgNoTags.join("ØŒ "));
  }

  // B) Parts selected for a fabric slot that has NO image yet (tags without fabric image)
  const partsFa = {back:"Ù¾Ø´ØªÛŒ", seat:"Ù†Ø´ÛŒÙ…Ù†", arms:"Ø¯Ø³ØªÙ‡â€ŒÙ‡Ø§"};
  const tagsNoImg = fabrics
    .map((f,i)=>({f,i}))
    .filter(({f})=> !f.url && f.parts && f.parts.size>0)
    .map(({f,i})=> `${[...f.parts].map(p=>partsFa[p]).join("ØŒ ")} â‡ Ù¾Ø§Ø±Ú†Ù‡ ${faOrdinal(i+1)}`);
  if(tagsNoImg.length>0){
    warnings.push("\n- Ø¨Ø®Ø´ Ù‡Ø§ÛŒ Ø§Ù†ØªØ®Ø§Ø¨ Ø´Ø¯Ù‡ Ú©Ù‡ Ù¾Ø§Ø±Ú†Ù‡â€ŒØ§ÛŒ Ø¨Ø±Ø§ÛŒØ´Ø§Ù† Ø§Ù†ØªØ®Ø§Ø¨ Ù†Ø´Ø¯Ù‡:\n " + tagsNoImg.join(" | "));
  }

  // C) Not all sofa parts (seat, back, arms) are assigned across fabrics
  (function(){
    const required = ["back","seat","arms"];
    const seen = new Set();
    fabrics.forEach(f=>{
      if(f && f.url && f.parts && f.parts.size>0){
        [...f.parts].forEach(p=>seen.add(p));
      }
    });
    const missing = required.filter(p=>!seen.has(p));
    if(missing.length>0){
      const partsFa2 = {back:"Ù¾Ø´ØªÛŒ", seat:"Ù†Ø´ÛŒÙ…Ù†", arms:"Ø¯Ø³ØªÙ‡â€ŒÙ‡Ø§"};
      warnings.push("\n- Ø¨Ø±Ø§ÛŒ Ø¨Ø±Ø®ÛŒ Ø¨Ø®Ø´â€ŒÙ‡Ø§ÛŒ Ù…Ø¨Ù„ Ù¾Ø§Ø±Ú†Ù‡ Ø¬Ø¯ÛŒØ¯ Ø§Ù†ØªØ®Ø§Ø¨ Ù†Ø´Ø¯Ù‡ Ø§Ø³Øª: " + missing.map(m=>partsFa2[m]).join("ØŒ "));
    }
  })();

  return {errors, warnings};
}

/* ========================== Export / ZIP Helpers ========================== */

function tsNow(){
  const p = new Date();
  const z = n=>String(n).padStart(2,'0');
  return `${p.getFullYear()}-${z(p.getMonth()+1)}-${z(p.getDate())}_${z(p.getHours())}-${z(p.getMinutes())}-${z(p.getSeconds())}`;
}
function ext(name){
  const i = name.lastIndexOf('.'); return i>=0 ? name.slice(i) : '.png';
}
function downloadBlob(blob, filename){
  const a=document.createElement('a');
  a.href=URL.createObjectURL(blob);
  a.download=filename;
  a.click();
  setTimeout(()=>URL.revokeObjectURL(a.href), 2500);
}

/** Build meta/files overview WITHOUT side effects (pure builder) */
function buildSofaMetaAndFiles(){
  // use global quality (no longer read from DOM)
  const quality = generationQuality;


  const included = [];
  const excluded = [];
  fabrics.forEach((f,fi)=>{
    const id = `fabric_${String(fi+1).padStart(2,'0')}`;
    const hasFile = !!f.file;
    const partsList = f.parts ? Array.from(f.parts) : [];
    if(hasFile && partsList.length>0){
      included.push({ id, parts: partsList, file: f.file });
    }else{
      const reason = !hasFile ? 'no image' : 'no parts';
      excluded.push({ id, reason });
    }
  });

  // Determine mode_selection for sofa:
  // "all"  â†’ if ANY fabric covers all three parts
  // "partial" â†’ otherwise
  let modeSelectionSofa = "partial";
  for (const f of fabrics) {
    if (f.parts && f.parts.size === 3) {
      modeSelectionSofa = "all";
      break;
    }
  }

  const meta = {
    mode: 'sofa',
    mode_selection: modeSelectionSofa,   // <-- NEW
    quality,
    fabrics: included.map(x=>({id:x.id, parts:x.parts})),
    excluded,
    files: {
      base_image: sofaBaseFile ? 'base_image'+ext(sofaBaseFile.name) : null,
      fabrics: included.map(x=> x.id + ext(x.file.name))
    }
  };



  const lines = [];
  const tz = Intl.DateTimeFormat().resolvedOptions().timeZone || 'local';
  lines.push('=== HEADER ===');
  lines.push('mode: sofa');
  lines.push(`timestamp: ${new Date().toLocaleString()} (${tz})`);
  lines.push(`quality: ${quality}`);
  lines.push('');
  lines.push('=== INCLUDED FABRICS ===');
  if(included.length===0){ lines.push('(none)'); }
  included.forEach(x=>{
    lines.push(`- ${x.id}: file="${x.id+ext(x.file.name)}"`);
    lines.push(`  sofa.parts: [${x.parts.join(', ')}]`);
  });
  lines.push('');
  lines.push('=== EXCLUSIONS (NOT SENT) ===');
  if(excluded.length===0){ lines.push('(none)'); }
  excluded.forEach(x=> lines.push(`- ${x.id}: reason=${x.reason}`));
  lines.push('');
  lines.push('=== FILES IN THIS EXPORT ===');
  if(sofaBaseFile) lines.push(`- ${'base_image'+ext(sofaBaseFile.name)}`);
  included.forEach(x=> lines.push(`- ${x.id+ext(x.file.name)}`));

  return {meta, included, metaTxt: lines.join('\n'), quality};
}

/* ========================== Toast (UI affordance) ========================= */

function showToast(msg){
  const t=document.getElementById('toast'); if(!t) return;
  t.textContent=msg; t.classList.add('show');
  setTimeout(()=>t.classList.remove('show'), 1600);
}

/* ============================ Named Handlers ============================== */

// Hamburger: toggle menu
function handleHamburgerClick(){
  menu.classList.toggle('show');
}
// Close menu on outside click
function handleDocumentClick(e){
  if(!menu.contains(e.target) && e.target!==hambtn) menu.classList.remove('show');
}

// Stage nav
function handlePrevStepClick(){
  if(idx>0){ idx--; updateUI(); } else { gotoUpload(); }
}
function handleNextBtnClick(){
  if(idx<fabrics.length-1){ idx++; updateUI(); }
}

// Add a new fabric slot (up to 3). Starts empty (no image, no parts).
function handleAddBtnClick(){
  if(addBtn.disabled) return;
  // Start fresh: clear file inputs so the next pick always fires 'change'
  try{ const _f=document.getElementById('fabFile'); if(_f) _f.value=''; }catch(e){}
  try{ const _c=document.getElementById('fabCam');  if(_c) _c.value=''; }catch(e){}
  fabrics.push({id:fabrics.length, url:'', parts:new Set()});
  idx = fabrics.length-1;
  updateUI();
}


// Stage 1: selecting the base sofa image enables Continue after load
async function handleSofaFileChange(e){
  const originalFile = e.target.files?.[0];
  if (!originalFile) return;

  // Compress / normalize if needed
  const file = await compressImageIfNeeded(originalFile, {
    maxBytes: MAX_BASE_BYTES,
    maxSide: BASE_MAX_SIDE
  });

  sofaChosen   = true;
  sofaBaseFile = file;

  toFabricsBtn.disabled = false;
  sofaThumb.innerHTML = '<img>';
  loadImage(sofaThumb.firstElementChild, file);
  if (baseImg2) {
    loadImage(baseImg2, file);
  }

  if (fabrics.length === 0) {
    fabrics.push({ id: 0, url: "", parts: new Set(["back", "seat", "arms"]) });
    assigned = { back: 0, seat: 0, arms: 0 };
  }
  idx = 0;
}


// Camera mirrors file selection
function handleSofaCamChange(){
  sofaFile.dispatchEvent(new Event('change'));
}
function handleToFabricsClick(){
  if(!sofaChosen) return;
  gotoFabrics();
}

// Fabric image selection for current fabric idx
async function setFabricFromFile(file){
  // Compress / normalize if needed
  const processed = await compressImageIfNeeded(file, {
    maxBytes: MAX_FABRIC_BYTES,
    maxSide: FABRIC_MAX_SIDE
  });

  // Revoke previous object URL (if any) to avoid leaks
  if (fabrics[idx]?.url) {
    try { URL.revokeObjectURL(fabrics[idx].url); } catch (e) {}
  }

  const url = URL.createObjectURL(processed);
  fabrics[idx].url  = url;
  fabrics[idx].file = processed;
  fabImg.src = url;

  updateUI();
}


async function handleFabFileChange(e){
  const f = e.target.files?.[0];
  if (!f) return;
  await setFabricFromFile(f);
  // Reset input so selecting the same file triggers 'change' in Chrome/Edge
  e.target.value = "";
}

async function handleFabCamChange(e){
  const f = e.target.files?.[0];
  if (!f) return;
  await setFabricFromFile(f);
  // Reset input so selecting the same capture triggers 'change' in Chrome/Edge
  e.target.value = "";
}


// Quality toggle: (high/standard) 
function handleQToggleClick(e){
  const b = e.target.closest('button');
  if(!b) return;

  // Update UI active state
  [...qToggle.children].forEach(x=>x.classList.toggle('active',x===b));

  // Update global quality state 
  generationQuality = b.dataset.q;
}


// Part assignment rules (see original comments)
function handleSchemClick(e){
  const btn=e.target.closest('.part'); if(!btn||!fabrics[idx]) return;
  const p=btn.dataset.part;
  const cur=fabrics[idx];

  if(p==='all'){
    const allAvail=parts.every(pa=>(assigned[pa]===null||assigned[pa]===cur.id));
    if(!allAvail) return;
    const turnOn=(cur.parts.size!==3);
    parts.forEach(pa=>{
      if(turnOn){ cur.parts.add(pa); assigned[pa]=cur.id; }
      else{ cur.parts.delete(pa); if(assigned[pa]===cur.id) assigned[pa]=null; }
    });
  }else{

    // If user clicks an individual part while "all" is active:
    // we must turn off "all" and activate only that specific part.
    if (cur.parts.size === 3 && p !== "all") {
      parts.forEach(pa => cur.parts.delete(pa)); // clear all
      cur.parts.add(p);                          // activate selected one
      // update assigned:
      parts.forEach(pa => { if (assigned[pa] === cur.id) assigned[pa] = null; });
      assigned[p] = cur.id;
      updateUI();
      return;
    }


    const visible=(assigned[p]===null||assigned[p]===cur.id);
    if(!visible) return;
    if(cur.parts.has(p)){ cur.parts.delete(p); if(assigned[p]===cur.id) assigned[p]=null; }
    else { cur.parts.add(p); assigned[p]=cur.id; }
  }
  updateUI();
}

// Validation + ZIP build + download
async function handlePreviewClick(){

  // ========== REQUIRE LOGIN ==========
  const token = localStorage.getItem("pishnama_user_token");
  if (!token) {
      alert("Ø¨Ø±Ø§ÛŒ Ø§Ø¯Ø§Ù…Ù‡ØŒ Ù„Ø·ÙØ§Ù‹ ÙˆØ§Ø±Ø¯ Ø´ÙˆÛŒØ¯.");
      loginModal.style.display = "flex";   // show the login modal automatically
      return;
  }


  const {errors, warnings} = validateBeforeGenerateSofa();
  if(errors.length>0){
    alert("Ø®Ø·Ø§Ù‡Ø§ÛŒ Ø¶Ø±ÙˆØ±ÛŒ: " + errors.join(" "));
    return;
  }
  if(warnings.length>0){
    const proceed = confirm("Ù…ÙˆØ§Ø±Ø¯ Ø§Ø®ØªÛŒØ§Ø±ÛŒ (Ù…ÛŒâ€ŒØªÙˆØ§Ù†ÛŒØ¯ Ø§ØµÙ„Ø§Ø­ Ú©Ù†ÛŒØ¯ ÛŒØ§ Ø§Ø¯Ø§Ù…Ù‡ Ø¯Ù‡ÛŒØ¯): " + warnings.join(" ") + "\nØ§Ø¯Ø§Ù…Ù‡Ù” ØªÙˆÙ„ÛŒØ¯ØŸ");
    if(!proceed) return;
  }



  const {meta, included} = buildSofaMetaAndFiles();

  try {
    enterLoadingState();
    const imageBase64 = await sendToBackend(meta, included, sofaBaseFile);
    if (!imageBase64) return;
    baseImg2.src = "data:image/png;base64," + imageBase64;
    refreshCredits();
  } catch (err) {
    console.error(err);
    // Do NOT show "Ø®Ø·Ø§..." if the user was logged out automatically
    if (err.message === "Unauthorized") {
        // Already handled by forceLogoutIfInvalid()
        return;
    }
    showToast("âŒ Ø®Ø·Ø§ Ø¯Ø± ØªÙˆÙ„ÛŒØ¯ ØªØµÙˆÛŒØ±. Ù„Ø·ÙØ§Ù‹ Ø¯ÙˆØ¨Ø§Ø±Ù‡ ØªÙ„Ø§Ø´ Ú©Ù†ÛŒØ¯.");
  } finally {
    exitLoadingState();
  }



}

// Remove current fabric (clears image + parts, reorders, selects next)
function handleRemoveFabricClick(){
  // Clear file inputs so re-selecting the same file triggers 'change'
  try{ const _f=document.getElementById('fabFile'); if(_f) _f.value=''; }catch(e){}
  try{ const _c=document.getElementById('fabCam');  if(_c) _c.value=''; }catch(e){}

  if(!fabrics[idx]) return;
  const removedIndex = idx;
  const removedId = fabrics[idx].id;

  // Revoke object URL to free memory
  try{ if(fabrics[idx].url) URL.revokeObjectURL(fabrics[idx].url); }catch(e){}
 // Clear assignments owned by this fabric
  parts.forEach(p=>{ if(assigned[p]===removedId) assigned[p]=null; });

  // Remove fabric slot
  fabrics.splice(idx,1);

  if(fabrics.length===0){
    fabrics.push({id:0,url:'', parts:new Set()});
    idx=0;
  }else{
    // Reindex ids
    fabrics.forEach((f,ii)=>{ f.id=ii; });
    // Shift assigned indices above removedId
    parts.forEach(p=>{ if(assigned[p]!=null && assigned[p]>removedId) assigned[p]=assigned[p]-1; });
    // Select the next fabric after removed (or clamp)
    idx = Math.min(removedIndex, fabrics.length-1);
  }

  showToast("Ù¾Ø§Ø±Ú†Ù‡ Ø­Ø°Ù Ø´Ø¯ â€” Ø¨Ø±Ú†Ø³Ø¨â€ŒÙ‡Ø§ÛŒ Ù…Ø±ØªØ¨Ø· Ù¾Ø§Ú© Ø´Ø¯Ù†Ø¯.");
  updateUI();
}

// ====== NEW: Backend integration & loading state ======
async function sendToBackend(meta, included, baseFile) {
  const form = new FormData();
  form.append("meta", JSON.stringify(meta));
  if (baseFile) form.append("base_image", baseFile);

  for (const it of included) {
    form.append(it.id, it.file);
  }

  // to be removed in the production version
  console.log("Outgoing FormData:", [...form.entries()]);

  const res = await fetch("/api/generate", {
    method: "POST",
    headers: {
        "x-user-token": localStorage.getItem("pishnama_user_token") || ""
    },
    body: form
  })


  if (!res.ok) {
    const data = await res.json().catch(() => null);

    // If backend says login is required, force logout
    if (forceLogoutIfInvalid(data)) {
      throw new Error("Unauthorized");
    }

    if (data?.error === "insufficient_credits") {
      alert(
        `Ø§Ø¹ØªØ¨Ø§Ø± Ú©Ø§ÙÛŒ Ù†ÛŒØ³Øª.\n` +
        `Ù…ÙˆØ¬ÙˆØ¯ÛŒ: ${data.credits}\n` +
        `Ù†ÛŒØ§Ø²: ${data.needed}`
      );
      return null;
    }


    throw new Error("Generation failed");
  }

  const data = await res.json();


  // If backend unexpectedly returns login_required here
  if (forceLogoutIfInvalid(data)) {
      throw new Error("Unauthorized");
  }

  return data.image_base64;

}

function enterLoadingState() {
  previewBtn.disabled = true;
  previewBtn.textContent = "â³ Ø¯Ø± Ø­Ø§Ù„ ØªÙˆÙ„ÛŒØ¯...";
  if (baseImg2) baseImg2.style.opacity = "0.4";
}

function exitLoadingState() {
  previewBtn.disabled = false;
  previewBtn.textContent = "âœ¨ Ù¾ÛŒØ´â€ŒÙ†Ù…Ø§ÛŒØ´";
  if (baseImg2) baseImg2.style.opacity = "1";
}


/* ============================== Event Bindings ============================ */

// Hamburger + outside close
hambtn.addEventListener('click', handleHamburgerClick);
document.addEventListener('click', handleDocumentClick);

// Stage navigation
prevStep.addEventListener('click', handlePrevStepClick);
nextBtn.addEventListener('click', handleNextBtnClick);

// Add fabric
addBtn.addEventListener('click', handleAddBtnClick);

// Stage 1 (Upload)
sofaFile.addEventListener('change', handleSofaFileChange);
sofaCam .addEventListener('change', handleSofaCamChange);
toFabricsBtn.addEventListener('click', handleToFabricsClick);

// Stage 2 (Fabrics)
fabFile.addEventListener('change', handleFabFileChange);
fabCam .addEventListener('change', handleFabCamChange);
qToggle.addEventListener('click', handleQToggleClick);
schem  .addEventListener('click', handleSchemClick);

// Generate (Preview)
previewBtn.addEventListener('click', handlePreviewClick);

// Remove fabric (IIFE in original â†’ direct binding here)
(function bindRemoveFabric(){
  const btn=document.getElementById('removeFabBtn');
  if(!btn) return;
  btn.addEventListener('click', handleRemoveFabricClick);
})();

/* ================================== Init ================================= */

// Ensure we start with an empty fabric slot if needed
(function init(){
  if(fabrics.length===0){
    fabrics.push({id:0,url:'', parts:new Set(['back','seat','arms'])});
    assigned = {back:0, seat:0, arms:0};
    idx=0;
  }
  // Do not call updateUI() here to avoid any visual flicker before user input.
})();

updateLoginButton();

refreshCredits();

</script>

<div id="toast" role="status" aria-live="polite"></div>

<!-- ========================= -->
<!-- "LOGIN MODAL" + "BUY CREDITS MODAL"  (HIDDEN INIT) -->
<!-- ========================= -->
<div id="loginModal" 
     style="position:fixed; inset:0; background:rgba(0,0,0,0.6); 
            display:none; align-items:center; justify-content:center; z-index:9999;">
  
  <div style="background:#0f162b; padding:20px; border-radius:12px; width:85%; max-width:340px; color:#e5e7eb;">
    <h3 style="margin-top:0;">ÙˆØ±ÙˆØ¯ / Ø«Ø¨Øª Ù†Ø§Ù…</h3>

    <label>Ø§ÛŒÙ…ÛŒÙ„ ÛŒØ§ Ø´Ù…Ø§Ø±Ù‡ Ù…ÙˆØ¨Ø§ÛŒÙ„:</label>
    <input id="loginIdentifier" style="width:100%; padding:8px; margin:8px 0; border-radius:8px;">
    
    <button id="sendCodeBtn" class="btn primary" style="width:100%; margin-bottom:10px;">Ø§Ø±Ø³Ø§Ù„ Ú©Ø¯</button>

    <label>Ú©Ø¯ Ú†Ù‡Ø§Ø± Ø±Ù‚Ù…ÛŒ:</label>
    <input id="loginCode" maxlength="4" style="width:100%; padding:8px; margin:8px 0; border-radius:8px;">

    <button id="verifyCodeBtn" class="btn" style="width:100%;">ØªØ§ÛŒÛŒØ¯</button>

    <button id="closeLoginModal" class="btn" style="margin-top:10px; width:100%;">Ø¨Ø³ØªÙ†</button>
  </div>
</div>

<div id="buyCreditsModal" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,.55); z-index:10000; align-items:center; justify-content:center;">
  <div style="width:min(420px,92vw); background:#0f1629; border:1px solid #3a4367; border-radius:12px; padding:14px;">
    <div style="display:flex; justify-content:space-between; align-items:center; gap:10px;">
      <div style="font-weight:700;">Ø®Ø±ÛŒØ¯ Ø§Ø¹ØªØ¨Ø§Ø±</div>
      <button class="btn" id="buyCreditsCloseBtn" style="padding:6px 10px;">âœ•</button>
    </div>

    <div style="margin-top:10px; font-size:13px; color:#cbd5e1;">
      (ÙØ¹Ù„Ø§Ù‹ Ø¨Ø¯ÙˆÙ† Ø¯Ø±Ú¯Ø§Ù‡ Ù¾Ø±Ø¯Ø§Ø®Øª ÙˆØ§Ù‚Ø¹ÛŒ) ÛŒÚ© Ø¨Ø³ØªÙ‡ Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯.
    </div>

    <div style="margin-top:12px; display:flex; flex-direction:column; gap:8px;">
      <button class="btn" data-pack="starter" style="width:100%;">Ø¨Ø³ØªÙ‡ Starter (Ù…Ø«Ù„Ø§Ù‹ 20 Ø§Ø¹ØªØ¨Ø§Ø±)</button>
      <button class="btn" data-pack="plus" style="width:100%;">Ø¨Ø³ØªÙ‡ Plus (Ù…Ø«Ù„Ø§Ù‹ 50 Ø§Ø¹ØªØ¨Ø§Ø±)</button>
      <button class="btn" data-pack="pro" style="width:100%;">Ø¨Ø³ØªÙ‡ Pro (Ù…Ø«Ù„Ø§Ù‹ 120 Ø§Ø¹ØªØ¨Ø§Ø±)</button>
    </div>
  </div>
</div>



<script>
  
// ============================
// SIMPLE LOGIN HANDLING
// ============================
const loginModal = document.getElementById("loginModal");
const loginBtn = document.getElementById("loginBtn");
const closeLoginModal = document.getElementById("closeLoginModal");
const sendCodeBtn = document.getElementById("sendCodeBtn");
const verifyCodeBtn = document.getElementById("verifyCodeBtn");


const userMenu = document.getElementById("userMenu");
const logoutBtn = document.getElementById("logoutBtn");

const buyCreditsBtn = document.getElementById("buyCreditsBtn");
const buyCreditsModal = document.getElementById("buyCreditsModal");
const buyCreditsCloseBtn = document.getElementById("buyCreditsCloseBtn");


function isValidEmail(str) {
    return /\S+@\S+\.\S+/.test(str);
}

function isValidPhone(str) {
    return /^09\d{9}$/.test(str);
}

function normalizePhone(str) {
    // input: 09123456789 â†’ output: +989123456789
    if (isValidPhone(str)) {
        return "+98" + str.slice(1);
    }
    return str;
}


// Toggle user menu when clicking the identifier (loginBtn)
loginBtn.onclick = () => {
    const token = localStorage.getItem("pishnama_user_token");
    if (token) {
        // User is logged in â†’ show/hide menu
        userMenu.style.display = 
            userMenu.style.display === "block" ? "none" : "block";
    } else {
        // User not logged in â†’ open login modal
        loginModal.style.display = "flex";
    }
};

logoutBtn.onclick = () => {
    // Clear stored credentials
    localStorage.removeItem("pishnama_user_token");
    localStorage.removeItem("pishnama_user_identifier");

    // Update UI
    updateLoginButton();

    // Hide menu
    userMenu.style.display = "none";

    // Optional user feedback
    showToast("Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø®Ø§Ø±Ø¬ Ø´Ø¯ÛŒØ¯.");

    document.getElementById("credit-info").textContent = "";

};

closeLoginModal.onclick = () => loginModal.style.display = "none";

function openBuyCreditsModal() {
  const token = localStorage.getItem("pishnama_user_token");
  if (!token) {
    alert("Ø¨Ø±Ø§ÛŒ Ø®Ø±ÛŒØ¯ Ø§Ø¹ØªØ¨Ø§Ø±ØŒ Ù„Ø·ÙØ§Ù‹ ÙˆØ§Ø±Ø¯ Ø´ÙˆÛŒØ¯.");
    loginModal.style.display = "flex";
    return;
  }
  buyCreditsModal.style.display = "flex";
}

function closeBuyCreditsModal() {
  buyCreditsModal.style.display = "none";
}

async function buyCredits(packageId, confirmBurn = false) {
  const token = localStorage.getItem("pishnama_user_token");
  if (!token) {
    alert("Ù„Ø·ÙØ§Ù‹ Ø¯ÙˆØ¨Ø§Ø±Ù‡ ÙˆØ§Ø±Ø¯ Ø´ÙˆÛŒØ¯.");
    return;
  }

  const packageMap = {
    starter: 20,
    plus: 50,
    pro: 120
  };

  const res = await fetch("/api/buy-credits", {
    method: "POST",
    headers: {
      "Content-Type": "application/json",
      "x-user-token": token
    },
    body: JSON.stringify({
      package_credits: packageMap[packageId],
      confirm: confirmBurn
    })
  });

  const data = await res.json().catch(() => null);

  // If backend says login is required, force logout (same pattern you already use)
  if (forceLogoutIfInvalid(data)) throw new Error("Unauthorized");

  if (!res.ok) {
    alert(data?.error || "Ø®Ø·Ø§ Ø¯Ø± Ø®Ø±ÛŒØ¯ Ø§Ø¹ØªØ¨Ø§Ø±");
    return;
  }

  // If backend requires confirmation because >threshold credits will burn
  if (data?.requires_confirmation) {
    const ok = confirm(data?.message || "ØªØ¹Ø¯Ø§Ø¯ÛŒ Ø§Ø² Ø§Ø¹ØªØ¨Ø§Ø±Ù‡Ø§ÛŒ ÙØ¹Ù„ÛŒ Ø´Ù…Ø§ Ù…ÛŒâ€ŒØ³ÙˆØ²Ø¯. Ø§Ø¯Ø§Ù…Ù‡ Ù…ÛŒâ€ŒØ¯Ù‡ÛŒØ¯ØŸ");
    if (!ok) return;
    return buyCredits(packageId, true);
  }

  alert("âœ… Ø®Ø±ÛŒØ¯ Ø§Ø¹ØªØ¨Ø§Ø± Ø§Ù†Ø¬Ø§Ù… Ø´Ø¯.");
  closeBuyCreditsModal();
  refreshCredits();
}

buyCreditsBtn?.addEventListener("click", openBuyCreditsModal);
buyCreditsCloseBtn?.addEventListener("click", closeBuyCreditsModal);

// Click outside card closes
buyCreditsModal?.addEventListener("click", (e) => {
  if (e.target === buyCreditsModal) closeBuyCreditsModal();
});

// Package buttons
buyCreditsModal?.querySelectorAll("[data-pack]")?.forEach(btn => {
  btn.addEventListener("click", () => buyCredits(btn.dataset.pack));
});


// Send code
sendCodeBtn.onclick = async () => {
  let identifier = document.getElementById("loginIdentifier").value.trim();
  if (!identifier) return alert("Ù„Ø·ÙØ§Ù‹ Ø§ÛŒÙ…ÛŒÙ„ ÛŒØ§ Ø´Ù…Ø§Ø±Ù‡ Ù…ÙˆØ¨Ø§ÛŒÙ„ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯.");

  if (!isValidEmail(identifier) && !isValidPhone(identifier)) {
      return alert("Ù„Ø·ÙØ§ Ø§ÛŒÙ…ÛŒÙ„ ÛŒØ§ Ø´Ù…Ø§Ø±Ù‡ Ù…ÙˆØ¨Ø§ÛŒÙ„ Ø±Ø§ Ø§ØµÙ„Ø§Ø­ ÙØ±Ù…Ø§ÛŒÛŒØ¯");
  }

  // Normalize phone to +98 format for backend
  identifier = normalizePhone(identifier);

  await fetch("/api/request-code", {
    method: "POST",
    headers: {"Content-Type": "application/json"},
    body: JSON.stringify({identifier})
  });

  alert("Ú©Ø¯ Ø¨Ø±Ø§ÛŒ Ø´Ù…Ø§ Ø§Ø±Ø³Ø§Ù„ Ø´Ø¯.");

};

// Verify
verifyCodeBtn.onclick = async () => {

  let identifier = document.getElementById("loginIdentifier").value.trim();
  if (!isValidEmail(identifier) && !isValidPhone(identifier)) {
      return alert("Ù„Ø·ÙØ§ Ø§ÛŒÙ…ÛŒÙ„ ÛŒØ§ Ø´Ù…Ø§Ø±Ù‡ Ù…ÙˆØ¨Ø§ÛŒÙ„ Ø±Ø§ Ø§ØµÙ„Ø§Ø­ ÙØ±Ù…Ø§ÛŒÛŒØ¯");
  }
  // normalize before sending to backend
  identifier = normalizePhone(identifier);
  

  const code = document.getElementById("loginCode").value.trim();

  const res = await fetch("/api/verify-code", {
    method: "POST",
    headers: {"Content-Type": "application/json"},
    body: JSON.stringify({identifier, code})
  });

  const data = await res.json();
  if (!data.token) return alert("Ú©Ø¯ Ø§Ø´ØªØ¨Ø§Ù‡ Ø§Ø³Øª.");

  // Save token + identifier
  localStorage.setItem("pishnama_user_token", data.token);
  localStorage.setItem("pishnama_user_identifier", identifier);

  // Close modal
  alert("ÙˆØ±ÙˆØ¯ Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø§Ù†Ø¬Ø§Ù… Ø´Ø¯!");
  loginModal.style.display = "none";

  // Update UI
  updateLoginButton();

  refreshCredits();

};


document.addEventListener("click", (e) => {
    if (!userMenu.contains(e.target) && e.target !== loginBtn) {
        userMenu.style.display = "none";
    }
});

window.addEventListener("storage", (e) => {
    if (e.key === "pishnama_user_token") {
        updateLoginButton();
        userMenu.style.display = "none";  // closes the user dropdown menu in other tabs after logout
        loginModal.style.display = "none";   // closes login panel in other tabs
    }

    if (localStorage.getItem("pishnama_user_token")) {
      refreshCredits();            // login in another tab
    } else {
      document.getElementById("credit-info").textContent = ""; // logout in another tab
    }

});


</script>


</body>
</html>
